<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOXY - Food Impact Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .input-section, .results-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 1.4em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .ingredient-selector {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .ingredient-item:last-child {
            border-bottom: none;
        }

        .ingredient-quantity {
            width: 100px;
            margin-left: 10px;
        }

        .dqr-meter {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .dqr-score {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .dqr-excellent { color: #27ae60; }
        .dqr-very-good { color: #2ecc71; }
        .dqr-good { color: #f39c12; }
        .dqr-fair { color: #e67e22; }
        .dqr-poor { color: #e74c3c; }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }

        .status-green { background: #d5f4e6; color: #27ae60; }
        .status-yellow { background: #fef9e7; color: #f39c12; }
        .status-red { background: #fdeaea; color: #e74c3c; }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .result-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #3498db;
        }

        .result-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }

        .result-label {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .story-card {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            color: #2d3436;
        }

        .comparison-tool {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            height: 300px;
        }

        .hidden {
            display: none;
        }

        .contributors-list {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .contributor-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .contributor-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± AIOXY Food Impact Calculator</h1>
            <p>EU Regulator-Ready PEF 3.1 Compliance ‚Ä¢ Real Environmental Storytelling</p>
        </div>

        <div class="main-content">
            <!-- INPUT SECTION -->
            <div class="input-section">
                <h2 class="section-title">üìä Product Configuration</h2>
                
                <div class="form-group">
                    <label for="productName">Product Name</label>
                    <input type="text" id="productName" placeholder="e.g., Vegan Burger" value="Vegan Burger">
                </div>

                <div class="form-group">
                    <label for="countryOrigin">Country of Origin</label>
                    <select id="countryOrigin">
                        <option value="UK">United Kingdom</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="ES">Spain</option>
                        <option value="IT">Italy</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="processingMethod">Processing Method</label>
                    <select id="processingMethod">
                        <option value="none">No Processing</option>
                        <option value="cooking">Cooking</option>
                        <option value="freezing">Freezing</option>
                        <option value="canning">Canning</option>
                        <option value="baking">Baking</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="transportDistance">Transport Distance (km)</label>
                    <input type="number" id="transportDistance" value="300" min="0">
                </div>

                <div class="form-group">
                    <label for="transportMode">Transport Mode</label>
                    <select id="transportMode">
                        <option value="road">Road</option>
                        <option value="rail">Rail</option>
                        <option value="sea">Sea</option>
                        <option value="air">Air</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Refrigerated Transport</label>
                    <select id="refrigeratedTransport">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="packagingMaterial">Packaging Material</label>
                    <select id="packagingMaterial">
                        <option value="cardboard">Cardboard</option>
                        <option value="plastic">Plastic</option>
                        <option value="glass">Glass</option>
                        <option value="metal">Metal</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="packagingWeight">Packaging Weight (kg)</label>
                    <input type="number" id="packagingWeight" value="0.05" step="0.01" min="0">
                </div>

                <div class="form-group">
                    <label for="recycledContent">Recycled Content (%)</label>
                    <input type="number" id="recycledContent" value="30" min="0" max="100">
                </div>

                <h3 class="section-title">ü•ó Ingredients</h3>
                <div class="ingredient-selector" id="ingredientSelector">
                    <!-- Ingredients will be populated by JavaScript -->
                </div>

                <button onclick="calculateImpact()">Calculate Environmental Impact</button>
                <button onclick="resetCalculator()" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d);">Reset</button>
            </div>

            <!-- RESULTS SECTION -->
            <div class="results-section">
                <h2 class="section-title">üìà Results & Analysis</h2>
                
                <div id="loadingMessage" class="hidden">Calculating... ‚è≥</div>
                
                <div id="resultsContent" class="hidden">
                    <!-- DQR METER -->
                    <div class="dqr-meter">
                        <h3>Compliance Score</h3>
                        <div id="dqrScore" class="dqr-score">-</div>
                        <div id="dqrStatus" class="status-badge">-</div>
                        <p>Data Quality Rating (1.0 = Best, 5.0 = Worst)</p>
                    </div>

                    <!-- KEY RESULTS -->
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-label">Climate Change</div>
                            <div id="co2Result" class="result-value">-</div>
                            <div class="result-label">kg CO‚ÇÇe per kg</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Water Scarcity</div>
                            <div id="waterResult" class="result-value">-</div>
                            <div class="result-label">m¬≥ world eq. per kg</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Land Use</div>
                            <div id="landResult" class="result-value">-</div>
                            <div class="result-label">m¬≤ per kg</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Fossil Resources</div>
                            <div id="fossilResult" class="result-value">-</div>
                            <div class="result-label">MJ per kg</div>
                        </div>
                    </div>

                    <!-- STORYTELLING -->
                    <div class="story-card" id="storyCard">
                        <h3>üåç Your Environmental Story</h3>
                        <div id="storyContent"></div>
                    </div>

                    <!-- COMPARISON TOOL -->
                    <div class="comparison-tool">
                        <h3>üíº Business Case Comparison</h3>
                        <div id="comparisonContent"></div>
                    </div>

                    <!-- PIE CHART -->
                    <div class="chart-container">
                        <h3>üìä Impact Contribution</h3>
                        <canvas id="impactChart"></canvas>
                    </div>

                    <!-- WORST CONTRIBUTORS -->
                    <div class="contributors-list">
                        <h3>‚ö†Ô∏è Data Quality Improvement Areas</h3>
                        <div id="contributorsContent"></div>
                    </div>
                </div>

                <div id="errorMessage" class="hidden" style="color: #e74c3c; text-align: center; padding: 20px;">
                    Error in calculation. Please check your inputs.
                </div>
            </div>
        </div>
    </div>

    <!-- LOAD ALL JAVASCRIPT FILES -->
    <script src="data.js"></script>
    <script src="ingredients.js"></script>
    <script src="food.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Global variables
        let selectedIngredients = [];
        let impactChart = null;

        // Initialize the ingredient selector
        function initializeIngredientSelector() {
            const container = document.getElementById('ingredientSelector');
            container.innerHTML = '';

            // Get first 20 ingredients for demo (in real app, use search/filter)
            const ingredientKeys = Object.keys(ingredients).slice(0, 20);
            
            ingredientKeys.forEach(key => {
                const ingredient = ingredients[key];
                const div = document.createElement('div');
                div.className = 'ingredient-item';
                div.innerHTML = `
                    <span>${ingredient.name}</span>
                    <input type="number" class="ingredient-quantity" 
                           id="qty_${key}" value="0" min="0" step="0.01"
                           onchange="updateIngredient('${key}', this.value)">
                `;
                container.appendChild(div);
            });
        }

        // Update ingredient selection
        function updateIngredient(id, quantity) {
            const numQuantity = parseFloat(quantity) || 0;
            const existingIndex = selectedIngredients.findIndex(item => item.id === id);
            
            if (numQuantity > 0) {
                if (existingIndex >= 0) {
                    selectedIngredients[existingIndex].quantity = numQuantity;
                } else {
                    selectedIngredients.push({
                        id: id,
                        quantity: numQuantity,
                        data: ingredients[id]
                    });
                }
            } else if (existingIndex >= 0) {
                selectedIngredients.splice(existingIndex, 1);
            }
        }

        // Main calculation function
        function calculateImpact() {
            const loading = document.getElementById('loadingMessage');
            const results = document.getElementById('resultsContent');
            const error = document.getElementById('errorMessage');
            
            loading.classList.remove('hidden');
            results.classList.add('hidden');
            error.classList.add('hidden');

            // Filter out zero quantity ingredients
            const activeIngredients = selectedIngredients.filter(item => item.quantity > 0);
            
            if (activeIngredients.length === 0) {
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                error.textContent = 'Please add at least one ingredient with quantity > 0';
                return;
            }

            // Prepare calculation options
            const options = {
                productName: document.getElementById('productName').value,
                manufacturingCountry: document.getElementById('countryOrigin').value,
                processingMethod: document.getElementById('processingMethod').value,
                transportDistance: parseFloat(document.getElementById('transportDistance').value),
                transportMode: document.getElementById('transportMode').value,
                refrigeratedTransport: document.getElementById('refrigeratedTransport').value === 'yes',
                packagingMaterial: document.getElementById('packagingMaterial').value,
                packagingWeight: parseFloat(document.getElementById('packagingWeight').value),
                recycledContent: parseFloat(document.getElementById('recycledContent').value),
                ingredients: activeIngredients
            };

            // Calculate using food.js engine
            setTimeout(() => {
                try {
                    const results = foodCalculationEngine.calculateFoodImpact(options);
                    displayResults(results);
                } catch (error) {
                    console.error('Calculation error:', error);
                    loading.classList.add('hidden');
                    document.getElementById('errorMessage').classList.remove('hidden');
                }
            }, 1000);
        }

        // Display results
        function displayResults(results) {
            document.getElementById('loadingMessage').classList.add('hidden');
            document.getElementById('resultsContent').classList.remove('hidden');

            // Update basic results
            document.getElementById('co2Result').textContent = results.co2PerKg.toFixed(3);
            document.getElementById('waterResult').textContent = results.waterScarcityPerKg.toFixed(6);
            document.getElementById('landResult').textContent = Math.round(results.landUsePerKg);
            document.getElementById('fossilResult').textContent = results.fossilPerKg.toFixed(1);

            // Update DQR meter
            const dqrScore = document.getElementById('dqrScore');
            const dqrStatus = document.getElementById('dqrStatus');
            dqrScore.textContent = results.overallDQR.toFixed(2);
            dqrScore.className = `dqr-score ${foodCalculationEngine.getDQRQualityLevel(results.overallDQR).class}`;
            
            let statusText = '', statusClass = '';
            if (results.overallDQR < 1.5) {
                statusText = 'Regulator Ready';
                statusClass = 'status-green';
            } else if (results.overallDQR < 2.5) {
                statusText = 'High-Quality Data';
                statusClass = 'status-yellow';
            } else {
                statusText = 'Claim at Risk - Review Sources';
                statusClass = 'status-red';
            }
            dqrStatus.textContent = statusText;
            dqrStatus.className = `status-badge ${statusClass}`;

            // Generate storytelling
            generateStorytelling(results);
            
            // Generate comparison tool
            generateComparisonTool(results);
            
            // Create pie chart
            createImpactChart(results);
            
            // Show worst contributors
            showWorstContributors(results);
        }

        // Storytelling engine
        function generateStorytelling(results) {
            const co2Saved = 2.5 - results.co2PerKg; // Example baseline
            const waterSaved = 0.0003 - results.waterScarcityPerKg; // Example baseline
            
            let story = '';
            
            if (co2Saved > 0) {
                const carKm = (co2Saved * 1000) / 0.2; // 0.2 kg CO2 per km for diesel car
                const smartphones = (co2Saved * 1000) / 0.008; // 0.008 kg CO2 per smartphone charge
                
                story += `<p>‚ú® <strong>${co2Saved.toFixed(2)} kg CO‚ÇÇe saved per kg</strong> compared to conventional products.</p>`;
                story += `<p>üöó Equivalent to <strong>${carKm.toFixed(0)} km</strong> less driving in a diesel car.</p>`;
                story += `<p>üì± Or <strong>${smartphones.toFixed(0)} smartphone charges</strong> saved.</p>`;
            }
            
            if (waterSaved > 0) {
                const peopleWater = (waterSaved * 1000) / 10; // 10L per person per day
                const showers = (waterSaved * 1000) / 60; // 60L per shower
                
                story += `<p>üíß <strong>${(waterSaved * 1000).toFixed(0)} liters water saved</strong> per kg product.</p>`;
                story += `<p>üë• Enough drinking water for <strong>${peopleWater.toFixed(0)} people</strong> for one day.</p>`;
                story += `<p>üöø Or <strong>${showers.toFixed(1)} fewer showers</strong> needed.</p>`;
            }
            
            document.getElementById('storyContent').innerHTML = story;
        }

        // Comparison tool
        function generateComparisonTool(results) {
            const conventionalCost = 2.50;
            const aioxyCost = 2.75;
            const co2Reduction = ((2.5 - results.co2PerKg) / 2.5 * 100).toFixed(0);
            const dqrImprovement = (3.1 - results.overallDQR).toFixed(1);
            
            let comparison = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                    <div style="text-align: center;">
                        <h4>Conventional</h4>
                        <div style="font-size: 1.8em; font-weight: bold;">‚Ç¨${conventionalCost}</div>
                        <div>Production Cost</div>
                    </div>
                    <div style="text-align: center;">
                        <h4>AIOXY Certified</h4>
                        <div style="font-size: 1.8em; font-weight: bold;">‚Ç¨${aioxyCost}</div>
                        <div>Production Cost</div>
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <p>‚úÖ <strong>${co2Reduction}% CO‚ÇÇ reduction</strong> achieved</p>
                    <p>üìä <strong>${dqrImprovement} point DQR improvement</strong> (3.1 ‚Üí ${results.overallDQR.toFixed(1)})</p>
                    <p>üå± <strong>Regulator-ready compliance</strong> for green claims</p>
                </div>
            `;
            
            document.getElementById('comparisonContent').innerHTML = comparison;
        }

        // Create impact pie chart
        function createImpactChart(results) {
            const ctx = document.getElementById('impactChart').getContext('2d');
            
            if (impactChart) {
                impactChart.destroy();
            }
            
            const contributions = results.auditTrail.pefCategories["Climate Change"].contribution_tree;
            const data = {
                labels: ['Ingredients', 'Manufacturing', 'Transport', 'Packaging'],
                datasets: [{
                    data: [
                        contributions.Ingredients.total,
                        contributions.Manufacturing.total,
                        contributions.Transport.total,
                        contributions.Packaging.total
                    ],
                    backgroundColor: [
                        '#3498db',
                        '#2ecc71', 
                        '#e74c3c',
                        '#f39c12'
                    ]
                }]
            };
            
            impactChart = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toFixed(3)} kg (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Show worst DQR contributors
        function showWorstContributors(results) {
            const contributors = results.auditTrail.dqr_summary.component_dqrs
                .sort((a, b) => a.dqr - b.dqr)
                .slice(0, 3);
            
            let html = '';
            contributors.forEach(contributor => {
                html += `
                    <div class="contributor-item">
                        <span>${contributor.name}</span>
                        <span style="color: ${contributor.dqr < 1.5 ? '#27ae60' : contributor.dqr < 2.5 ? '#f39c12' : '#e74c3c'}">
                            DQR: ${contributor.dqr.toFixed(2)}
                        </span>
                    </div>
                `;
            });
            
            document.getElementById('contributorsContent').innerHTML = html;
        }

        // Reset calculator
        function resetCalculator() {
            selectedIngredients = [];
            document.getElementById('ingredientSelector').querySelectorAll('input[type="number"]').forEach(input => {
                input.value = '0';
            });
            document.getElementById('resultsContent').classList.add('hidden');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeIngredientSelector();
            
            // Add some demo ingredients
            setTimeout(() => {
                document.getElementById('qty_beef-eu-conv').value = '0.15';
                updateIngredient('beef-eu-conv', '0.15');
                document.getElementById('qty_wheat-eu-conv').value = '0.1';
                updateIngredient('wheat-eu-conv', '0.1');
                document.getElementById('qty_tomatoes-es-field').value = '0.05';
                updateIngredient('tomatoes-es-field', '0.05');
            }, 500);
        });
    </script>
</body>
    </html>
