<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOXY | Science-Based Sustainability Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }

        :root {
            --primary: #0A2540;
            --primary-light: #1A365D;
            --primary-dark: #061B2E;
            --secondary: #00D4AA;
            --secondary-dark: #00B894;
            --accent: #FF6B6B;
            --light: #F8FAFC;
            --dark: #2D3748;
            --gray: #718096;
            --border: #E2E8F0;
            --card-bg: #FFFFFF;
            --success: #48BB78;
            --warning: #ED8936;
            --gradient-primary: linear-gradient(135deg, #0A2540 0%, #1A365D 100%);
            --gradient-secondary: linear-gradient(135deg, #00D4AA 0%, #00B894 100%);
            --gradient-accent: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 40px rgba(0,0,0,0.15);
            
            --dqr-excellent: #48BB78;
            --dqr-very-good: #68D391;
            --dqr-good: #ECC94B;
            --dqr-fair: #ED8936;
            --dqr-poor: #FC8181;
        }

        body {
            background: linear-gradient(135deg, #F8FAFC 0%, #EDF2F7 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .header {
            background: var(--gradient-primary);
            color: white;
            padding: 2.5rem 3rem;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 400px;
            height: 400px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .logo {
            font-size: 2.75rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            background: var(--gradient-secondary);
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: var(--shadow-md);
        }

        .tagline {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .compliance-badge {
            background: rgba(255,255,255,0.15);
            padding: 0.6rem 1.25rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 0 3rem;
            position: relative;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 1.25rem 2rem;
            background: none;
            border: none;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0.05;
            transition: left 0.3s ease;
        }

        .nav-tab:hover::before {
            left: 0;
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--secondary);
        }

        .nav-tab.active::before {
            left: 0;
        }

        .main-content {
            padding: 2.5rem 3rem;
            display: grid;
            gap: 2rem;
            grid-template-columns: 1fr 1fr;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.375rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(10, 37, 64, 0.1);
        }

        .btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--gradient-secondary);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-accent {
            background: var(--gradient-accent);
        }

        .ingredient-list {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .ingredient-item:hover {
            background: rgba(0, 212, 170, 0.05);
        }

        .ingredient-item:last-child {
            border-bottom: none;
        }

        .ingredient-info {
            flex: 1;
        }

        .ingredient-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .ingredient-stats {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .ingredient-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .quantity-input {
            width: 90px;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            text-align: center;
        }

        .remove-btn {
            background: var(--gradient-accent);
            color: white;
            border: none;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .remove-btn:hover {
            transform: scale(1.1);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .metric-card {
            background: white;
            padding: 1.5rem 1rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow-md);
            border-top: 4px solid var(--primary);
            transition: transform 0.3s ease;
            position: relative;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .metric-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(10, 37, 64, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.75rem;
            font-size: 1.25rem;
            color: var(--primary);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin: 0.25rem 0;
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .savings-badge {
            background: var(--gradient-secondary);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .chart-container {
            height: 250px;
            margin: 1.5rem 0;
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: var(--shadow-md);
        }

        .environmental-story {
            background: var(--gradient-primary);
            color: white;
            padding: 1.75rem;
            border-radius: 14px;
            margin: 1.5rem 0;
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        .environmental-story::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: rgba(255,255,255,0.05);
            transform: rotate(30deg);
        }

        .story-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .story-content {
            line-height: 1.6;
            font-size: 1rem;
            position: relative;
            z-index: 2;
        }

        .story-highlight {
            background: rgba(255,255,255,0.15);
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid var(--secondary);
        }

        .compliance-notice {
            background: #E3F2FD;
            border: 1px solid #2196F3;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            font-size: 0.9rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .compliance-icon {
            background: #2196F3;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid rgba(10, 37, 64, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .transport-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .advanced-options {
            background: var(--light);
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border-left: 4px solid var(--primary);
        }

        .section-divider {
            height: 1px;
            background: var(--border);
            margin: 1.5rem 0;
        }

        .footer {
            background: var(--primary-dark);
            color: white;
            padding: 1.5rem 3rem;
            text-align: center;
            font-size: 0.85rem;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-links {
            display: flex;
            gap: 1.5rem;
        }

        .footer-links a {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: white;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-secondary);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 0.75rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: normal;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(0, 212, 170, 0.1);
            color: var(--secondary-dark);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .tab-indicator {
            position: absolute;
            bottom: 0;
            height: 3px;
            background: var(--secondary);
            transition: left 0.3s ease, width 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 2rem 1.5rem;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 150px;
            justify-content: center;
        }

        .dpp-section {
            background: var(--light);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .qrcode-container {
            display: inline-block;
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            margin: 1rem 0;
        }

        .dpp-id {
            font-family: monospace;
            background: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            display: inline-block;
            margin: 1rem 0;
            font-weight: 600;
        }

        .impact-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .comparison-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--secondary);
        }

        .comparison-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0.5rem 0;
        }

        .comparison-label {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .pef-scorecard {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            box-shadow: var(--shadow-md);
            overflow-x: auto;
        }

        .pef-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .pef-table th {
            background: var(--light);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
        }

        .pef-table td {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
        }

        .pef-table tr:hover {
            background: rgba(0, 212, 170, 0.05);
        }

        .pef-category {
            font-weight: 600;
            color: var(--primary);
        }

        .pef-value {
            font-family: monospace;
            font-weight: 600;
        }

        .pef-unit {
            color: var(--gray);
            font-size: 0.85rem;
        }

        .mass-balance {
            background: var(--light);
            border-radius: 10px;
            padding: 1.25rem;
            margin: 1rem 0;
            border-left: 4px solid var(--secondary);
        }

        .mass-balance-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mass-balance-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .mass-balance-item:last-child {
            border-bottom: none;
            font-weight: 600;
            color: var(--primary);
        }

        .dqr-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dqr-excellent { background: var(--dqr-excellent); color: white; }
        .dqr-very-good { background: var(--dqr-very-good); color: white; }
        .dqr-good { background: var(--dqr-good); color: var(--dark); }
        .dqr-fair { background: var(--dqr-fair); color: white; }
        .dqr-poor { background: var(--dqr-poor); color: white; }

        .source-badge {
            background: rgba(10, 37, 64, 0.1);
            color: var(--primary);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-family: monospace;
        }

        .data-quality-section {
            background: var(--light);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .dqr-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .dqr-factor {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }

        .dqr-factor-value {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .dqr-factor-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .audit-trail-section {
            background: var(--light);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .audit-category {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .audit-category-header {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .audit-component {
            background: rgba(10, 37, 64, 0.03);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .audit-component-header {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .audit-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            font-size: 0.85rem;
        }

        .audit-item-name {
            flex: 2;
        }

        .audit-item-value {
            flex: 1;
            text-align: right;
            font-family: monospace;
        }

        .story-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .story-item {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .story-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .story-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .story-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .export-section {
            background: var(--light);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .export-card {
            background: white;
            padding: 2rem 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .export-card:hover {
            transform: translateY(-5px);
            border-color: var(--secondary);
            box-shadow: var(--shadow-lg);
        }

        .export-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.8rem;
            color: white;
        }

        .export-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .export-desc {
            font-size: 0.9rem;
            color: var(--gray);
            line-height: 1.5;
        }

        #pdf-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 37, 64, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            flex-direction: column;
            gap: 1rem;
            backdrop-filter: blur(5px);
        }

        #pdf-loading-overlay .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top: 6px solid var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        #pdf-loading-overlay h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .business-case {
            background: var(--light);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
        }

        .business-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .business-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: var(--shadow-md);
        }

        .business-value {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--primary);
            margin: 0.5rem 0;
        }

        .business-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .roi-badge {
            background: var(--gradient-secondary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .scenario-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .scenario-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .scenario-card:hover {
            transform: translateY(-3px);
            border-color: var(--secondary);
            box-shadow: var(--shadow-lg);
        }

        .scenario-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .scenario-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .scenario-desc {
            font-size: 0.85rem;
            color: var(--gray);
            line-height: 1.4;
        }

        .multi-comparison {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            box-shadow: var(--shadow-md);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .comparison-item {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            background: var(--light);
            border: 2px solid transparent;
        }

        .comparison-item.best {
            border-color: var(--success);
            background: rgba(72, 187, 120, 0.1);
        }

        .comparison-item.worst {
            border-color: var(--accent);
            background: rgba(255, 107, 107, 0.1);
        }

        .comparison-item-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .comparison-item-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .comparison-item-savings {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .savings-positive {
            color: var(--success);
        }

        .savings-negative {
            color: var(--accent);
        }

        /* NEW: Universal Comparison Grid Styles */
        .universal-comparison-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .universal-comparison-item {
            padding: 1rem;
            border-radius: 8px;
            background: white;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .universal-comparison-item.highlight {
            border: 2px solid var(--success);
            background: rgba(72, 187, 120, 0.05);
        }

        .bar-container {
            flex-grow: 1;
            margin: 0 15px;
            background: #eee;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: var(--primary);
            transition: width 1s ease;
        }

        .highlight .bar-fill {
            background: var(--success);
        }

        /* NEW: Scenario Grid Styles */
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .scenario-btn {
            background: white;
            border: 1px solid var(--border);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .scenario-btn:hover, .scenario-btn.active {
            border-color: var(--secondary);
            background: var(--light);
            transform: translateY(-2px);
        }

        .scenario-btn i {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
            display: block;
        }

        /* NEW: Financial Ledger Styles */
        .ledger-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .ledger-table th {
            text-align: left;
            padding: 10px;
            color: #718096;
            border-bottom: 2px solid var(--border);
        }

        .ledger-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .money-positive {
            color: var(--success);
            font-weight: 700;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1.5rem;
            }
            
            .header {
                padding: 2rem 1.5rem;
            }
            
            .nav-tabs {
                padding: 0 1.5rem;
            }
            
            .nav-tab {
                padding: 1rem 1.25rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .transport-section {
                grid-template-columns: 1fr;
            }
            
            .footer-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .footer-links {
                gap: 1rem;
            }
            
            .impact-comparison {
                grid-template-columns: 1fr;
            }
            
            .pef-table {
                font-size: 0.8rem;
            }
            
            .pef-table th,
            .pef-table td {
                padding: 8px 10px;
            }

            .dqr-breakdown {
                grid-template-columns: repeat(3, 1fr);
            }

            .story-comparison {
                grid-template-columns: 1fr;
            }

            .export-options {
                grid-template-columns: 1fr;
            }

            .business-metrics {
                grid-template-columns: 1fr;
            }

            .scenario-buttons {
                grid-template-columns: 1fr;
            }

            .comparison-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .universal-comparison-grid {
                grid-template-columns: 1fr;
            }

            .scenario-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-leaf"></i>
                    </div>
                    AIOXY
                </div>
                <div class="tagline">Science-Based Sustainability Intelligence Platform</div>
                <div class="compliance-badge">
                    <i class="fas fa-shield-alt"></i>
                    Standard-Aligned • PEF 3.1 Methodology • Verification-Ready
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="tab-indicator" id="tabIndicator"></div>
            <button class="nav-tab active" onclick="showTab('calculator')">
                <i class="fas fa-calculator"></i>
                Calculator
            </button>
            <button class="nav-tab" onclick="showTab('results')">
                <i class="fas fa-chart-line"></i>
                Results
            </button>
            <button class="nav-tab" onclick="showTab('business-case')">
                <i class="fas fa-euro-sign"></i>
                Business Case
            </button>
            <button class="nav-tab" onclick="showTab('pef-scorecard')">
                <i class="fas fa-list-ol"></i>
                PEF Scorecard
            </button>
            <button class="nav-tab" onclick="showTab('dpp')">
                <i class="fas fa-qrcode"></i>
                Transparency Card
            </button>
            <button class="nav-tab" onclick="showTab('export')">
                <i class="fas fa-file-export"></i>
                Export Reports
            </button>
            <button class="nav-tab" onclick="showTab('transparency')">
                <i class="fas fa-search"></i>
                Transparency Log
            </button>
            <button class="nav-tab" onclick="showTab('methodology')">
                <i class="fas fa-file-contract"></i>
                Methodology
            </button>
        </div>

        <div class="main-content">
            <!-- Calculator Tab -->
            <div id="calculator-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            Product Information
                        </div>
                        <div class="badge">
                            <i class="fas fa-info-circle"></i>
                            Required for Transparency Card
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Product Name</label>
                        <input type="text" id="productName" class="form-control" placeholder="Enter product name" value="Plant-Based Protein Burger">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Product Category (Smart Baseline Detection)</label>
                        <select id="productCategory" class="form-control" onchange="updateComparison()">
                            <option value="auto">✨ Auto-Detect (Recommended)</option>
                            <option value="dairy_alt">Plant-Based Milk</option>
                            <option value="meat_alt">Plant-Based Meat</option>
                            <option value="dairy">Dairy Product</option>
                            <option value="meat">Meat Product</option>
                            <option>Personal Care</option>
                            <option>Household Products</option>
                            <option>Textiles</option>
                            <option>Electronics</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Product Weight (kg)</label>
                        <input type="number" id="productWeight" class="form-control" value="0.200" step="0.001" min="0">
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-balance-scale"></i>
                            </div>
                            Performance Comparison
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Compare Against</label>
                        <select id="comparisonBaseline" class="form-control" onchange="updateComparison()">
                            <option value="auto">Auto-detect (Recommended)</option>
                            
                            <optgroup label="Food Products">
                                <option value="beef-product">Conventional Beef Product</option>
                                <option value="chicken-product">Conventional Chicken Product</option>
                                <option value="pork-product">Conventional Pork Product</option>
                                <option value="cheese-product">Conventional Cheese Product</option>
                                <option value="coffee-product">Conventional Coffee Product</option>
                                <option value="chocolate-product">Conventional Chocolate Product</option>
                                <option value="bread-product">Conventional Bread Product</option>
                            </optgroup>
                            
                            <optgroup label="Personal Care">
                                <option value="shampoo-conventional">Conventional Shampoo</option>
                                <option value="soap-conventional">Conventional Soap</option>
                                <option value="lotion-conventional">Conventional Lotion</option>
                            </optgroup>
                            
                            <optgroup label="Textiles">
                                <option value="cotton-tshirt">Conventional Cotton T-Shirt</option>
                                <option value="polyester-tshirt">Conventional Polyester T-Shirt</option>
                            </optgroup>
                            
                            <optgroup label="Beverages">
                                <option value="soda-drink">Conventional Soda Drink</option>
                                <option value="juice-drink">Conventional Juice Drink</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Custom Baseline (kg CO₂e/kg)</label>
                        <input type="number" id="customBaseline" class="form-control" placeholder="Enter custom competitor baseline" step="0.1" min="0">
                        <small style="color: var(--gray); font-size: 0.8rem;">Use this to compare against specific competitors</small>
                    </div>
                    
                    <div class="compliance-notice" style="margin-top: 1rem;">
                        <div class="compliance-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <strong>Smart Detection Active</strong><br>
                            System automatically detects product type and selects the most relevant comparison baseline.
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-apple-alt"></i>
                            </div>
                            Ingredients (Science-Based)
                        </div>
                        <div class="badge">
                            <i class="fas fa-database"></i>
                            50 Ingredients • AGRIBALYSE 3.2 • DQR Rated
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Select Ingredient</label>
                        <select id="ingredientSelect" class="form-control">
                            <option value="">Choose from science-based ingredients...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity (kg)</label>
                        <input type="number" id="ingredientQuantity" value="0.150" step="0.001" min="0" class="form-control">
                    </div>
                    <button class="btn" onclick="addIngredient()">
                        <i class="fas fa-plus"></i>
                        Add Ingredient
                    </button>
                    
                    <div class="ingredient-list" id="ingredientList">
                        <div class="empty-state">
                            <i class="fas fa-apple-alt"></i>
                            <h3>No ingredients added yet</h3>
                            <p>Add ingredients to calculate your environmental impact</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-industry"></i>
                            </div>
                            Manufacturing & Supply Chain
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Manufacturing Country</label>
                        <select id="manufacturingCountry" class="form-control">
                            <option value="">Select country...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Processing Method</label>
                        <select id="processingMethod" class="form-control">
                            <option value="none">No Additional Processing</option>
                            <option value="pasteurization">Pasteurization</option>
                            <option value="sterilization">Sterilization (UHT)</option>
                            <option value="baking">Baking</option>
                            <option value="frying">Frying</option>
                            <option value="freezing">Freezing (IQF)</option>
                            <option value="drying">Spray Drying</option>
                            <option value="milling">Milling</option>
                            <option value="mixing">Mixing/Blending</option>
                            <option value="fermentation">Fermentation</option>
                            <option value="extrusion">Extrusion</option>
                            <option value="oat-processing">Oat Enzyming/Heat Treatment</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Transportation</label>
                        <div class="transport-section">
                            <div>
                                <label class="form-label">Distance (km)</label>
                                <input type="number" id="transportDistance" value="300" min="0" class="form-control">
                            </div>
                            <div>
                                <label class="form-label">Transport Mode</label>
                                <select id="transportMode" class="form-control">
                                    <option value="road">Road Freight (HGV Diesel)</option>
                                    <option value="rail">Rail Freight (Electric)</option>
                                    <option value="sea">Sea Freight (Container)</option>
                                    <option value="air">Air Freight</option>
                                    <option value="lastmile">Last-mile Delivery</option>
                                    <option value="electric_van">Electric Van</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-outline" onclick="toggleAdvanced()">
                        <i class="fas fa-cog"></i>
                        Advanced Options
                    </button>

                    <div class="advanced-options hidden" id="advancedOptions">
                        <div class="form-group">
                            <label class="form-label">Refrigerated Transport</label>
                            <select id="refrigeratedTransport" class="form-control">
                                <option value="no">No Refrigeration</option>
                                <option value="yes">Refrigerated (+20-40% emissions)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Energy Source</label>
                            <select id="energySource" class="form-control">
                                <option value="grid">Grid Mix (Regional)</option>
                                <option value="renewable">Renewable Energy</option>
                                <option value="natural_gas">Natural Gas</option>
                                <option value="coal">Coal</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-box-open"></i>
                            </div>
                            Packaging Materials
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Primary Packaging Material</label>
                        <select id="packagingMaterial" class="form-control">
                            <option value="cardboard">Cardboard (Coated)</option>
                            <option value="PET">PET Plastic</option>
                            <option value="rPET">rPET (Recycled)</option>
                            <option value="HDPE">HDPE Plastic</option>
                            <option value="LDPE">LDPE Plastic</option>
                            <option value="PP">PP Plastic</option>
                            <option value="glass">Glass</option>
                            <option value="aluminum">Aluminum</option>
                            <option value="steel">Steel</option>
                            <option value="PLA">PLA Bioplastic</option>
                            <option value="mycelium">Mycelium Foam</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Packaging Weight (kg)</label>
                        <input type="number" id="packagingWeight" value="0.050" step="0.001" min="0" class="form-control">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Recycled Content (%)</label>
                        <input type="number" id="recycledContent" value="30" min="0" max="100" class="form-control">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 30%;"></div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="calculateImpact()" style="width: 100%; padding: 1.25rem; font-size: 1.1rem;">
                    <i class="fas fa-rocket"></i>
                    Calculate Environmental Impact
                </button>
            </div>

            <!-- Results Tab -->
            <div id="results-tab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            Impact Analysis
                        </div>
                        <div class="badge">
                            <i class="fas fa-clock"></i>
                            PEF 3.1 Methodology • AWARE • Data Quality Rated
                        </div>
                    </div>
                    
                    <div class="loading hidden" id="loadingResults">
                        <div class="spinner"></div>
                        <h3>Calculating Environmental Footprint...</h3>
                        <p style="font-size: 0.9rem; color: var(--gray); margin-top: 0.5rem;">
                            Processing 16 impact categories with AGRIBALYSE 3.2 data and uncertainty calculations
                        </p>
                    </div>

                    <div id="resultsContent">
                        <!-- Data Quality Summary -->
                        <div class="data-quality-section hidden" id="dataQualitySection">
                            <h3 style="margin-bottom: 1rem; color: var(--primary);">
                                <i class="fas fa-chart-line"></i>
                                Data Quality Assessment
                            </h3>
                            <div class="dqr-breakdown" id="dqrBreakdown">
                                <!-- DQR factors will be populated here -->
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <span class="dqr-badge dqr-excellent" id="overallDQRBadge">
                                    <i class="fas fa-star"></i>
                                    Overall Data Quality: Excellent
                                </span>
                            </div>
                        </div>

                        <!-- Mass Balance Section -->
                        <div class="mass-balance hidden" id="massBalanceSection">
                            <div class="mass-balance-title">
                                <i class="fas fa-balance-scale"></i>
                                Mass Balance Verification
                            </div>
                            <div id="massBalanceContent">
                                <!-- Mass balance items will be populated here -->
                            </div>
                        </div>

                        <div class="results-grid">
                            <div class="metric-card">
                                <div class="metric-icon">
                                    <i class="fas fa-smog"></i>
                                </div>
                                <div class="metric-value" id="co2Value">0.00 kg</div>
                                <div class="metric-label">CO₂e per kg</div>
                                <div class="savings-badge" id="co2Savings">0% saved</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-icon">
                                    <i class="fas fa-tint"></i>
                                </div>
                                <div class="metric-value" id="waterValue">0 m³</div>
                                <div class="metric-label">Water Scarcity per kg</div>
                                <div class="savings-badge" id="waterSavings">0% saved</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-icon">
                                    <i class="fas fa-mountain"></i>
                                </div>
                                <div class="metric-value" id="landValue">0 Pt</div>
                                <div class="metric-label">Land Use per kg</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-icon">
                                    <i class="fas fa-fire"></i>
                                </div>
                                <div class="metric-value" id="fossilValue">0 MJ</div>
                                <div class="metric-label">Fossil Resources</div>
                            </div>
                        </div>

                        <!-- NEW: Universal Comparison Engine -->
                        <div class="multi-comparison" id="universalComparisonSection">
                            <h3 style="margin-bottom: 1rem; color: var(--primary);">
                                <i class="fas fa-chart-bar"></i>
                                Universal Product Comparison
                            </h3>
                            <div style="background: #E3F2FD; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <i class="fas fa-robot" style="color: var(--primary);"></i>
                                <strong id="baselineName">Comparing against: Detecting...</strong>
                            </div>
                            <div class="universal-comparison-grid" id="universalComparisonGrid">
                                <!-- Universal comparison items will be populated here -->
                            </div>
                        </div>

                        <!-- Enhanced Storytelling Section -->
                        <div class="environmental-story hidden" id="environmentalStory">
                            <div class="story-title">
                                <i class="fas fa-globe-europe"></i>
                                Environmental Impact Story
                            </div>
                            <div class="story-content" id="storyContent">
                                <!-- Dynamic story content will be populated here -->
                            </div>
                            <div class="story-comparison" id="storyComparison">
                                <!-- Story comparison items will be populated here -->
                            </div>
                        </div>

                        <div class="chart-container">
                            <canvas id="emissionChart"></canvas>
                        </div>

                        <div class="impact-comparison">
                            <div class="comparison-card">
                                <i class="fas fa-car" style="font-size: 2rem; color: var(--secondary); margin-bottom: 1rem;"></i>
                                <div class="comparison-value" id="carKm">0 km</div>
                                <div class="comparison-label">Equivalent car distance saved</div>
                            </div>
                            <div class="comparison-card">
                                <i class="fas fa-home" style="font-size: 2rem; color: var(--secondary); margin-bottom: 1rem;"></i>
                                <div class="comparison-value" id="householdEnergy">0 days</div>
                                <div class="comparison-label">Household energy consumption</div>
                            </div>
                            <div class="comparison-card">
                                <i class="fas fa-tree" style="font-size: 2rem; color: var(--secondary); margin-bottom: 1rem;"></i>
                                <div class="comparison-value" id="treesPlanted">0 trees</div>
                                <div class="comparison-label">Equivalent CO₂ absorption</div>
                            </div>
                            <div class="comparison-card">
                                <i class="fas fa-wine-bottle" style="font-size: 2rem; color: var(--secondary); margin-bottom: 1rem;"></i>
                                <div class="comparison-value" id="waterBottles">0 bottles</div>
                                <div class="comparison-label">Drinking water equivalent</div>
                            </div>
                        </div>

                        <div class="compliance-notice">
                            <div class="compliance-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <div>
                                <strong>Verification-Ready Assessment</strong><br>
                                This assessment follows PEF 3.1 methodology using AGRIBALYSE 3.2, JRC EF 3.1, and AWARE 2.0 data. 
                                All claims are substantiated and transparent through the Digital Transparency Card.
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn" onclick="showTab('business-case')">
                                <i class="fas fa-euro-sign"></i>
                                View Business Case
                            </button>
                            <button class="btn" onclick="showTab('pef-scorecard')">
                                <i class="fas fa-list-ol"></i>
                                View Full PEF Scorecard
                            </button>
                            <button class="btn" onclick="showTab('dpp')">
                                <i class="fas fa-qrcode"></i>
                                Generate Transparency Card
                            </button>
                            <button class="btn" onclick="generatePDFReport('comprehensive')">
                                <i class="fas fa-file-pdf"></i>
                                Download PDF Report
                            </button>
                        </div>
                    </div>
                </div>
                        </div>
            

            <!-- Business Case Tab -->
            <div id="business-case-tab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-euro-sign"></i>
                            </div>
                            Business Case & ROI Analysis
                        </div>
                        <div class="badge">
                            <i class="fas fa-chart-line"></i>
                            Financial Impact • ROI • Market Advantage • Scales from 1 to Billions
                        </div>
                    </div>

                    <div class="business-case">
                        <!-- VOLUME SELECTOR SYSTEM -->
                        <div class="form-group" style="background: white; padding: 2rem; border-radius: 12px; border: 2px solid var(--border); margin-bottom: 2rem;">
                            <label class="form-label" style="font-size: 1.1rem; margin-bottom: 1.5rem;">
                                <i class="fas fa-boxes"></i>
                                Annual Production Volume
                            </label>
                            
                            <!-- Quick Select Buttons -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin-bottom: 1.5rem;">
                                <button class="btn btn-outline" onclick="setVolume(100)">100 units</button>
                                <button class="btn btn-outline" onclick="setVolume(1000)">1,000 units</button>
                                <button class="btn btn-outline" onclick="setVolume(10000)">10,000 units</button>
                                <button class="btn btn-outline" onclick="setVolume(100000)">100,000 units</button>
                                <button class="btn btn-outline" onclick="setVolume(1000000)">1 Million</button>
                                <button class="btn btn-outline" onclick="setVolume(10000000)">10 Million</button>
                                <button class="btn btn-outline" onclick="setVolume(100000000)">100 Million</button>
                                <button class="btn btn-outline" onclick="setVolume(1000000000)">1 Billion</button>
                            </div>
                            
                            <!-- Precision Slider -->
                            <div style="margin-bottom: 1rem;">
                                <input type="range" id="salesVolume" min="1" max="1000000000" value="10000" 
                                       step="1" style="width: 100%; height: 8px; border-radius: 4px;"
                                       oninput="updateVolumeDisplay(this.value); updateBusinessCase();">
                            </div>
                            
                            <!-- Volume Display -->
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: 800; color: var(--primary); margin-bottom: 0.5rem;">
                                    <span id="volumeDisplay">10,000</span>
                                </div>
                                <div style="font-size: 1rem; color: var(--gray);">
                                    <span id="businessScaleDisplay">Growing Business</span>
                                    • Tier: <span id="volumeTierDisplay">10K-100K</span>
                                </div>
                            </div>
                        </div>

                        <!-- NEW: Physics-Based What-If Simulator -->
                        <h3 style="margin: 1.5rem 0 1rem 0; color: var(--primary);">What-If Scenarios (Physics-Based)</h3>
                        <div class="scenario-grid">
                            <div class="scenario-btn" id="scenario-renewables" onclick="toggleScenario('renewables')">
                                <i class="fas fa-solar-panel"></i>
                                <div style="font-weight: 600;">Renewable Energy</div>
                                <div style="font-size: 0.75rem; color: gray;">Drops Scope 2 Carbon</div>
                            </div>
                            
                            <div class="scenario-btn" id="scenario-local" onclick="toggleScenario('local')">
                                <i class="fas fa-truck"></i>
                                <div style="font-weight: 600;">Local Sourcing</div>
                                <div style="font-size: 0.75rem; color: gray;">Reduce Dist. to 50km</div>
                            </div>
                            
                            <div class="scenario-btn" id="scenario-lightweight" onclick="toggleScenario('lightweight')">
                                <i class="fas fa-feather"></i>
                                <div style="font-weight: 600;">Lightweight Pkg</div>
                                <div style="font-size: 0.75rem; color: gray;">-20% Material Wgt</div>
                            </div>
                            
                            <div class="scenario-btn" id="scenario-reset" onclick="resetScenarios()">
                                <i class="fas fa-undo"></i>
                                <div style="font-weight: 600;">Reset All</div>
                                <div style="font-size: 0.75rem; color: gray;">Baseline Physics</div>
                            </div>
                        </div>

                        <!-- NEW: Hard Financial Math Ledger -->
                        <div style="margin-top: 2rem;">
                            <h3 style="margin-bottom: 1rem; color: var(--primary);">
                                <i class="fas fa-calculator"></i>
                                Financial Impact Analysis (Real Physics)
                            </h3>
                            <table class="ledger-table">
                                <thead>
                                    <tr>
                                        <th>Cost Driver (Real Math)</th>
                                        <th>Physics Delta</th>
                                        <th>Financial Impact</th>
                                    </tr>
                                </thead>
                                <tbody id="ledgerBody">
                                    <!-- Ledger rows will be populated here -->
                                </tbody>
                            </table>
                            
                            <div style="margin-top: 1.5rem; text-align: right;">
                                <div style="font-size: 0.9rem; color: gray;">Total Annual Benefit</div>
                                <div style="font-size: 2rem; font-weight: 800; color: var(--success);" id="totalBenefit">€0</div>
                            </div>
                        </div>

                        <div class="business-metrics">
                            <div class="business-card">
                                <i class="fas fa-rocket" style="font-size: 2rem; color: var(--secondary); margin-bottom: 1rem;"></i>
                                <div class="business-value" id="roiValue">0%</div>
                                <div class="business-label">ROI (3-Year)</div>
                                <div class="roi-badge" id="roiBadge">CALCULATING</div>
                            </div>
                            
                            <div class="business-card">
                                <i class="fas fa-piggy-bank" style="font-size: 2rem; color: var(--secondary); margin-bottom: 1rem;"></i>
                                <div class="business-value" id="savingsValue">€0</div>
                                <div class="business-label">Annual Cost Savings</div>
                            </div>
                            
                            <div class="business-card">
                                <i class="fas fa-chart-bar" style="font-size: 2rem; color: var(--secondary); margin-bottom: 1rem;"></i>
                                <div class="business-value" id="premiumValue">0%</div>
                                <div class="business-label">Price Premium Potential</div>
                            </div>
                            
                            <div class="business-card">
                                <i class="fas fa-users" style="font-size: 2rem; color: var(--secondary); margin-bottom: 1rem;"></i>
                                <div class="business-value" id="marketValue">0%</div>
                                <div class="business-label">Market Share Growth</div>
                            </div>
                        </div>

                        <!-- COST BREAKDOWN -->
                        <div class="mass-balance" style="margin-top: 2rem;">
                            <div class="mass-balance-title">
                                <i class="fas fa-euro-sign"></i>
                                Investment & Return Breakdown
                            </div>
                            <div class="mass-balance-item">
                                <span>Implementation Cost:</span>
                                <span id="implementationCost">€0</span>
                            </div>
                            <div class="mass-balance-item">
                                <span>Annual Carbon Reduction:</span>
                                <span id="carbonReductionDisplay">0 kg CO₂e</span>
                            </div>
                            <div class="mass-balance-item">
                                <span>Total Annual Benefit:</span>
                                <span id="totalBenefitDisplay">€0</span>
                            </div>
                            <div class="mass-balance-item" style="font-weight: 600; color: var(--primary);">
                                <span>3-Year Net Return:</span>
                                <span id="netReturnDisplay">€0</span>
                            </div>
                        </div>

                        <div class="environmental-story" style="margin-top: 2rem;">
                            <div class="story-title">
                                <i class="fas fa-bullseye"></i>
                                Strategic Business Impact
                            </div>
                            <div class="story-content" id="businessStory">
                                <!-- Business story will be populated here -->
                            </div>
                        </div>

                        <div class="compliance-notice" style="margin-top: 2rem;">
                            <div class="compliance-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <strong>Brand Value Enhancement</strong><br>
                                Science-based sustainability data builds consumer trust and loyalty. 
                                Transparent environmental reporting attracts eco-conscious customers and supports premium pricing strategies.
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn" onclick="showTab('results')">
                                <i class="fas fa-arrow-left"></i>
                                Back to Results
                            </button>
                            <button class="btn btn-success" onclick="generatePDFReport('executive')">
                                <i class="fas fa-file-pdf"></i>
                                Download Business Case
                            </button>
                            <button class="btn" onclick="showTab('export')">
                                <i class="fas fa-file-export"></i>
                                Export All Reports
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PEF Scorecard Tab -->
            <div id="pef-scorecard-tab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-list-ol"></i>
                            </div>
                            Complete PEF 3.1 Impact Scorecard
                        </div>
                        <div class="badge">
                            <i class="fas fa-file-certificate"></i>
                            Science-Based • 16 Impact Categories • DQR Rated
                        </div>
                    </div>

                    <div class="compliance-notice">
                        <div class="compliance-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div>
                            <strong>Standard-Aligned PEF 3.1 Methodology</strong><br>
                            This scorecard presents the complete environmental footprint across all 16 mandatory PEF impact categories. 
                            All values are calculated using JRC EF 3.1 characterization factors and are transparent for verification purposes.
                        </div>
                    </div>

                    <div class="pef-scorecard">
                        <table class="pef-table">
                            <thead>
                                <tr>
                                    <th>Impact Category</th>
                                    <th>Total Impact</th>
                                    <th>Unit</th>
                                    <th>Per kg Product</th>
                                    <th>Data Quality</th>
                                    <th>Uncertainty</th>
                                </tr>
                            </thead>
                            <tbody id="pefScorecardBody">
                                <!-- PEF scorecard will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="data-quality-section">
                        <h3 style="margin-bottom: 1rem; color: var(--primary);">
                            <i class="fas fa-database"></i>
                            Data Quality Breakdown
                        </h3>
                        <div id="ingredientDataQuality">
                            <!-- Ingredient data quality will be populated here -->
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn" onclick="showTab('dpp')">
                            <i class="fas fa-qrcode"></i>
                            Generate Transparency Card with Full Data
                        </button>
                        <button class="btn" onclick="generatePDFReport('technical')">
                            <i class="fas fa-file-pdf"></i>
                            Download Scorecard PDF
                        </button>
                        <button class="btn btn-outline" onclick="downloadRawData()">
                            <i class="fas fa-download"></i>
                            Download Raw Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Digital Transparency Card Tab -->
            <div id="dpp-tab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-passport"></i>
                            </div>
                            Digital Transparency Card
                        </div>
                        <div class="badge">
                            <i class="fas fa-qrcode"></i>
                            Science-Based • Full PEF Data • DQR Embedded
                        </div>
                    </div>

                    <div class="dpp-section">
                        <h3 style="margin-bottom: 1rem; color: var(--primary);">Your Product's Environmental Profile</h3>
                        <p style="margin-bottom: 1.5rem; color: var(--gray);">
                            Scan this QR code to access the complete 16-impact environmental footprint and transparency data
                        </p>
                        
                        <div class="qrcode-container">
                            <div id="qrcode"></div>
                        </div>
                        
                        <div class="dpp-id" id="dppId">TRC-#####-#####</div>
                        
                        <p style="font-size: 0.9rem; color: var(--gray); max-width: 600px; margin: 0 auto;">
                            This Digital Transparency Card contains the complete PEF 3.1 16-impact matrix, supply chain transparency information, 
                            and methodology documentation aligned with science-based sustainability reporting.
                        </p>
                    </div>

                    <div class="compliance-notice">
                        <div class="compliance-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div>
                            <strong>Complete PEF Data Embedded</strong><br>
                            This transparency card contains the full 16-impact PEF matrix. Data structure follows JSON-LD format 
                            with interoperability standards. Includes: complete PEF impact data, ingredient origins, processing methods, 
                            packaging calculations, and methodology documentation.
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn" onclick="generateDPP()">
                            <i class="fas fa-sync-alt"></i>
                            Regenerate Card
                        </button>
                        <button class="btn" onclick="downloadDPPData()">
                            <i class="fas fa-download"></i>
                            Download Card Data
                        </button>
                        <button class="btn btn-outline" onclick="generatePDFReport('dpp')">
                            <i class="fas fa-print"></i>
                            Print QR Label
                        </button>
                    </div>
                </div>
            </div>

            <!-- Export Reports Tab -->
            <div id="export-tab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-file-export"></i>
                            </div>
                            Export Reports
                        </div>
                        <div class="badge">
                            <i class="fas fa-file-pdf"></i>
                            Professional Reports • Verification-Ready • Multiple Formats
                        </div>
                    </div>

                    <div class="export-section">
                        <h3 style="margin-bottom: 1rem; color: var(--primary); text-align: center;">
                            Generate Professional Reports
                        </h3>
                        <p style="text-align: center; color: var(--gray); margin-bottom: 2rem;">
                            Download comprehensive reports for stakeholders, marketing, or internal documentation
                        </p>
                        
                        <div class="export-options">
                            <div class="export-card" onclick="generatePDFReport('marketing')">
                                <div class="export-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="export-title">Marketing Report</div>
                                <div class="export-desc">
                                    Consumer-friendly environmental performance overview with key metrics and storytelling elements.
                                </div>
                            </div>
                            
                            <div class="export-card" onclick="generatePDFReport('executive')">
                                <div class="export-icon">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div class="export-title">Executive Summary</div>
                                <div class="export-desc">
                                    High-level environmental performance overview with key metrics and improvement opportunities.
                                </div>
                            </div>
                            
                            <div class="export-card" onclick="generatePDFReport('technical')">
                                <div class="export-icon">
                                    <i class="fas fa-calculator"></i>
                                </div>
                                <div class="export-title">Technical Report</div>
                                <div class="export-desc">
                                    Detailed technical documentation with full calculation methodology and data sources.
                                </div>
                            </div>
                            
                            <div class="export-card" onclick="generatePDFReport('transparency')">
                                <div class="export-icon">
                                    <i class="fas fa-qrcode"></i>
                                </div>
                                <div class="export-title">Transparency Package</div>
                                <div class="export-desc">
                                    Complete Digital Transparency Card documentation with QR codes and methodology statements.
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="generatePDFReport('comprehensive')">
                                <i class="fas fa-file-pdf"></i>
                                Generate All Reports
                            </button>
                            <button class="btn btn-outline" onclick="downloadAllData()">
                                <i class="fas fa-database"></i>
                                Download Complete Dataset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transparency Log Tab -->
            <div id="transparency-tab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            Transparency Log
                        </div>
                        <div class="badge">
                            <i class="fas fa-shield-alt"></i>
                            Science-Based • Full Transparency
                        </div>
                    </div>

                    <div class="compliance-notice">
                        <div class="compliance-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div>
                            <strong>Complete Calculation Transparency</strong><br>
                            This transparency log shows every calculation step and data source used in the environmental assessment. 
                            Stakeholders can verify every impact value back to its source data and methodology.
                        </div>
                    </div>

                    <div class="audit-trail-section" id="auditTrailContent">
                        <!-- Audit trail will be populated here -->
                        <div class="empty-state">
                            <i class="fas fa-calculator"></i>
                            <h3>No calculation data available</h3>
                            <p>Calculate environmental impacts first to generate the transparency log</p>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn" onclick="calculateImpact(); showTab('transparency')">
                            <i class="fas fa-sync-alt"></i>
                            Regenerate Log
                        </button>
                        <button class="btn" onclick="exportAuditData()">
                            <i class="fas fa-download"></i>
                            Export Log Data
                        </button>
                        <button class="btn btn-outline" onclick="showTab('methodology')">
                            <i class="fas fa-file-contract"></i>
                            View Methodology
                        </button>
                    </div>
                </div>
            </div>

            <!-- Methodology Tab -->
            <div id="methodology-tab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-icon">
                                <i class="fas fa-file-certificate"></i>
                            </div>
                            Methodology
                        </div>
                    </div>
                    
                    <div class="compliance-notice">
                        <div class="compliance-icon">
                            <i class="fas fa-flask"></i>
                        </div>
                        <div>
                            <strong>Science-Based Methodology Statement</strong><br><br>
                            Environmental estimates made by AIOXY regarding this product are based on a Life Cycle Assessment (LCA) 
                            conducted using the Product Environmental Footprint (PEF) methodology as defined by the European Commission Joint Research Centre (JRC).<br><br>
                            The specific methodology, including data sources (AGRIBALYSE 3.2, JRC EF 3.1, GLEC v3.0) and calculation rules (CFF, AWARE, Economic Allocation), 
                            is fully documented and transparent via the Digital Transparency Card.
                        </div>
                    </div>
                    
                    <h3 style="margin: 1.5rem 0 1rem 0; color: var(--primary);">PEF 3.1 Methodology Used</h3>
                    
                    <div class="results-grid">
                        <div class="metric-card">
                            <div class="metric-icon">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div class="metric-value">AWARE 2.0</div>
                            <div class="metric-label">Water Scarcity</div>
                            <p style="margin-top: 0.75rem; font-size: 0.85rem;">
                                Regionalized water impact assessment with watershed-specific characterization factors
                            </p>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-icon">
                                <i class="fas fa-recycle"></i>
                            </div>
                            <div class="metric-value">CFF</div>
                            <div class="metric-label">Circular Footprint</div>
                            <p style="margin-top: 0.75rem; font-size: 0.85rem;">
                                Packaging end-of-life calculations with allocation factors
                            </p>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="metric-value">PEF</div>
                            <div class="metric-label">Allocation</div>
                            <p style="margin-top: 0.75rem; font-size: 0.85rem;">
                                PEF-compliant economic allocation hierarchy for co-products
                            </p>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="metric-value">DQR</div>
                            <div class="metric-label">Data Quality</div>
                            <p style="margin-top: 0.75rem; font-size: 0.85rem;">
                                ISO 14044-compliant Data Quality Rating (TeR, GR, TiR, C, P)
                            </p>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <h3 style="margin: 1.5rem 0 1rem 0; color: var(--primary);">Data Quality Rating (DQR) System</h3>
                    
                    <div class="data-quality-section">
                        <div class="dqr-breakdown">
                            <div class="dqr-factor">
                                <div class="dqr-factor-value">1.3</div>
                                <div class="dqr-factor-label">TeR</div>
                                <div style="font-size: 0.7rem; margin-top: 0.5rem;">Technological Representativeness</div>
                            </div>
                            <div class="dqr-factor">
                                <div class="dqr-factor-value">1.9</div>
                                <div class="dqr-factor-label">GR</div>
                                <div style="font-size: 0.7rem; margin-top: 0.5rem;">Geographical Representativeness</div>
                            </div>
                            <div class="dqr-factor">
                                <div class="dqr-factor-value">1.0</div>
                                <div class="dqr-factor-label">TiR</div>
                                <div style="font-size: 0.7rem; margin-top: 0.5rem;">Time Representativeness</div>
                            </div>
                            <div class="dqr-factor">
                                <div class="dqr-factor-value">1.4</div>
                                <div class="dqr-factor-label">C</div>
                                <div style="font-size: 0.7rem; margin-top: 0.5rem;">Completeness</div>
                            </div>
                            <div class="dqr-factor">
                                <div class="dqr-factor-value">1.0</div>
                                <div class="dqr-factor-label">P</div>
                                <div style="font-size: 0.7rem; margin-top: 0.5rem;">Parameter Uncertainty</div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 1.5rem;">
                            <div class="dqr-badge dqr-excellent">
                                <i class="fas fa-star"></i>
                                Overall DQR: 1.3 (Excellent)
                            </div>
                            <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--gray);">
                                DQR scores range from 1 (Excellent) to 5 (Poor). Lower scores indicate higher data quality and reliability.
                            </p>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <h3 style="margin: 1.5rem 0 1rem 0; color: var(--primary);">16 PEF Impact Categories</h3>
                    <div class="pef-scorecard">
                        <table class="pef-table">
                            <thead>
                                <tr>
                                    <th>Impact Category</th>
                                    <th>Unit</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="pef-category">Climate Change</td>
                                    <td class="pef-unit">kg CO₂e</td>
                                    <td>Global warming potential over 100 years</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Ozone Depletion</td>
                                    <td class="pef-unit">kg CFC11e</td>
                                    <td>Stratospheric ozone layer depletion</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Human Toxicity (cancer)</td>
                                    <td class="pef-unit">CTUh</td>
                                    <td>Comparative Toxic Unit for humans (cancer effects)</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Human Toxicity (non-cancer)</td>
                                    <td class="pef-unit">CTUh</td>
                                    <td>Comparative Toxic Unit for humans (non-cancer effects)</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Particulate Matter</td>
                                    <td class="pef-unit">disease inc.</td>
                                    <td>Respiratory effects from particulate matter</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Ionizing Radiation</td>
                                    <td class="pef-unit">kBq U235e</td>
                                    <td>Human health effects from ionizing radiation</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Photochemical Ozone Formation</td>
                                    <td class="pef-unit">kg NMVOCe</td>
                                    <td>Summer smog formation potential</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Acidification</td>
                                    <td class="pef-unit">mol H+e</td>
                                    <td>Soil and water acidification potential</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Eutrophication (terrestrial)</td>
                                    <td class="pef-unit">mol N e</td>
                                    <td>Terrestrial nutrient enrichment</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Eutrophication (freshwater)</td>
                                    <td class="pef-unit">kg P e</td>
                                    <td>Freshwater nutrient enrichment</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Eutrophication (marine)</td>
                                    <td class="pef-unit">kg N e</td>
                                    <td>Marine nutrient enrichment</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Ecotoxicity (freshwater)</td>
                                    <td class="pef-unit">CTUe</td>
                                    <td>Comparative Toxic Unit for ecosystems</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Land Use</td>
                                    <td class="pef-unit">Pt</td>
                                    <td>Soil quality and biodiversity impact</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Water Use/Scarcity</td>
                                    <td class="pef-unit">m³ world eq.</td>
                                    <td>Water deprivation (AWARE method)</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Resource Use (minerals/metals)</td>
                                    <td class="pef-unit">kg Sb e</td>
                                    <td>Abiotic resource depletion for minerals and metals</td>
                                </tr>
                                <tr>
                                    <td class="pef-category">Resource Use (fossils)</td>
                                    <td class="pef-unit">MJ</td>
                                    <td>Abiotic resource depletion for fossil resources</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="action-buttons">
                        <button class="btn" onclick="downloadMethodology()">
                            <i class="fas fa-file-download"></i>
                            Download Methodology
                        </button>
                        <button class="btn btn-outline" onclick="showTab('export')">
                            <i class="fas fa-user-check"></i>
                            Request Verification
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-content">
                <div>© 2024 AIOXY Sustainability Intelligence. Estimates based on Agribalyse 3.1 data. For consumer information and marketing purposes only.</div>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Documentation</a>
                    <a href="#">Contact</a>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Loading Overlay -->
    <div id="pdf-loading-overlay">
        <div class="spinner"></div>
        <h3>Generating Report...</h3>
        <p>This may take a few moments.</p>
    </div>
    <!-- SCRIPT TAGS AT THE BOTTOM -->
    <script src="ingredients.js"></script>
    <script>
        // ================== UNIVERSAL COMPARISON SYSTEM ==================
        const UNIVERSAL_BASELINES = {
            // FOOD & BEVERAGE
            'beef-product': {
                name: 'Conventional Beef Product',
                category: 'food',
                co2PerKg: 30.8,
                waterPerKg: 8.1,
                landUsePerKg: 11500,
                fossilPerKg: 20.8
            },
            'chicken-product': {
                name: 'Conventional Chicken Product',
                category: 'food', 
                co2PerKg: 3.3,
                waterPerKg: 1.7,
                landUsePerKg: 710,
                fossilPerKg: 9.9
            },
            'pork-product': {
                name: 'Conventional Pork Product',
                category: 'food',
                co2PerKg: 5.2,
                waterPerKg: 2.2,
                landUsePerKg: 810,
                fossilPerKg: 11.8
            },
            'cheese-product': {
                name: 'Conventional Cheese Product',
                category: 'food',
                co2PerKg: 8.5,
                waterPerKg: 3.2,
                landUsePerKg: 1200,
                fossilPerKg: 6.8
            },
            'milk-product': {
                name: 'Conventional Dairy Product',
                category: 'food',
                co2PerKg: 1.3,
                waterPerKg: 0.95,
                landUsePerKg: 760,
                fossilPerKg: 1.9
            },
            'coffee-product': {
                name: 'Conventional Coffee Product',
                category: 'food',
                co2PerKg: 19.5,
                waterPerKg: 3.4,
                landUsePerKg: 1450,
                fossilPerKg: 39.0
            },
            'chocolate-product': {
                name: 'Conventional Chocolate Product',
                category: 'food',
                co2PerKg: 14.5,
                waterPerKg: 1.95,
                landUsePerKg: 2150,
                fossilPerKg: 26.5
            },
            'bread-product': {
                name: 'Conventional Bread Product',
                category: 'food',
                co2PerKg: 0.8,
                waterPerKg: 0.6,
                landUsePerKg: 250,
                fossilPerKg: 3.2
            },
            
            // PERSONAL CARE
            'shampoo-conventional': {
                name: 'Conventional Shampoo',
                category: 'personal-care',
                co2PerKg: 2.8,
                waterPerKg: 1.2,
                landUsePerKg: 150,
                fossilPerKg: 15.4
            },
            'soap-conventional': {
                name: 'Conventional Soap',
                category: 'personal-care',
                co2PerKg: 1.8,
                waterPerKg: 0.8,
                landUsePerKg: 120,
                fossilPerKg: 8.7
            },
            'lotion-conventional': {
                name: 'Conventional Lotion',
                category: 'personal-care',
                co2PerKg: 3.2,
                waterPerKg: 1.5,
                landUsePerKg: 180,
                fossilPerKg: 12.3
            },
            
            // TEXTILES
            'cotton-tshirt': {
                name: 'Conventional Cotton T-Shirt',
                category: 'textiles',
                co2PerKg: 3.6,
                waterPerKg: 13.8,
                landUsePerKg: 2050,
                fossilPerKg: 12.1
            },
            'polyester-tshirt': {
                name: 'Conventional Polyester T-Shirt',
                category: 'textiles',
                co2PerKg: 4.1,
                waterPerKg: 0.24,
                landUsePerKg: 14,
                fossilPerKg: 44.5
            },
            
            // BEVERAGES
            'soda-drink': {
                name: 'Conventional Soda Drink',
                category: 'beverage',
                co2PerKg: 0.4,
                waterPerKg: 0.8,
                landUsePerKg: 85,
                fossilPerKg: 2.1
            },
            'juice-drink': {
                name: 'Conventional Juice Drink',
                category: 'beverage',
                co2PerKg: 1.2,
                waterPerKg: 1.5,
                landUsePerKg: 320,
                fossilPerKg: 4.8
            },
            
            // PLANT-BASED ALTERNATIVES FOR MULTI-COMPARISON
            'almond-milk': {
                name: 'Almond Milk',
                category: 'beverage',
                co2PerKg: 0.75,
                waterPerKg: 1.8,
                landUsePerKg: 180,
                fossilPerKg: 2.1
            },
            'soy-milk': {
                name: 'Soy Milk',
                category: 'beverage',
                co2PerKg: 0.55,
                waterPerKg: 0.9,
                landUsePerKg: 220,
                fossilPerKg: 1.8
            },
            'lamb-product': {
                name: 'Lamb Product',
                category: 'food',
                co2PerKg: 25.2,
                waterPerKg: 7.5,
                landUsePerKg: 10500,
                fossilPerKg: 19.2
            },
            'turkey-product': {
                name: 'Turkey Product',
                category: 'food',
                co2PerKg: 4.1,
                waterPerKg: 1.9,
                landUsePerKg: 790,
                fossilPerKg: 11.0
            }
        };

        // ================== HARD FINANCIAL MATH ENGINE ==================
        const FINANCIALS = {
            carbon_price: 0.085, // €85/ton (Shadow Price)
            elec_price: 0.22, // €0.22/kWh (Industrial)
            diesel_price: 1.75, // €1.75/L
            logistics_factor: 0.03 // L diesel per ton-km
        };

        const PHYSICS = {
            transport_dist_std: 500, // km
            transport_dist_local: 50, // km
            pack_co2: { "cardboard": 0.8, "pet": 2.5, "glass": 0.9, "aluminum": 9.0 },
            energy_co2: { "grid": 0.4, "green": 0.02 } // kg CO2 per kWh
        };

        // ================== SMART CATEGORY DETECTION ==================
        function detectProductCategory(productName, ingredients, selectedCategory) {
            const name = productName.toLowerCase();
            const category = selectedCategory.toLowerCase();
            
            // 1. Check Ingredients FIRST (More accurate)
            const hasOats = ingredients.some(ing => ing.id.includes('oat'));
            const hasAlmond = ingredients.some(ing => ing.id.includes('almond'));
            const hasSoy = ingredients.some(ing => ing.id.includes('soy'));
            const hasWater = ingredients.some(ing => ing.id.includes('water'));
            
            // 2. SMART DETECTION LOGIC
            if ((name.includes('milk') || name.includes('drink') || name.includes('latte') || hasOats || hasAlmond || hasSoy) && !name.includes('burger')) {
                return 'milk-product'; // Oat milk vs cow milk, not beef
            }
            
            // Check product name for clues
            if (name.includes('burger') || name.includes('patty') || name.includes('sausage')) {
                return 'beef-product';
            }
            if (name.includes('pizza')) return 'cheese-product';
            if (name.includes('coffee') || name.includes('espresso') || name.includes('latte')) return 'coffee-product';
            if (name.includes('chocolate') || name.includes('cocoa') || name.includes('candy')) return 'chocolate-product';
            if (name.includes('bread') || name.includes('bun') || name.includes('roll')) return 'bread-product';
            if (name.includes('shampoo') || name.includes('conditioner')) return 'shampoo-conventional';
            if (name.includes('soap') || name.includes('bar')) return 'soap-conventional';
            if (name.includes('lotion') || name.includes('cream')) return 'lotion-conventional';
            if (name.includes('tshirt') || name.includes('shirt') || name.includes('garment')) return detectTextileType(ingredients);
            if (name.includes('soda') || name.includes('cola') || name.includes('soft drink')) return 'soda-drink';
            if (name.includes('juice') || name.includes('smoothie')) return 'juice-drink';
            
            // Fall back to category selection
            if (category.includes('personal care') || category.includes('cosmetic')) return 'shampoo-conventional';
            if (category.includes('textile') || category.includes('clothing')) return 'cotton-tshirt';
            if (category.includes('beverage') || category.includes('drink')) return 'soda-drink';
            
            // Default food comparison
            return detectFoodType(ingredients);
        }

        function detectFoodType(ingredients) {
            // Analyze ingredients to detect food type
            const hasBeef = ingredients.some(ing => ing.id.includes('beef') || ing.id.includes('lamb'));
            const hasChicken = ingredients.some(ing => ing.id.includes('chicken') || ing.id.includes('turkey'));
            const hasPork = ingredients.some(ing => ing.id.includes('pork') || ing.id.includes('bacon'));
            const hasDairy = ingredients.some(ing => ing.id.includes('milk') || ing.id.includes('cheese') || ing.id.includes('butter'));
            const hasCoffee = ingredients.some(ing => ing.id.includes('coffee'));
            const hasCocoa = ingredients.some(ing => ing.id.includes('cocoa') || ing.id.includes('chocolate'));
            const hasOats = ingredients.some(ing => ing.id.includes('oat'));
            const hasSoy = ingredients.some(ing => ing.id.includes('soy'));
            const hasAlmond = ingredients.some(ing => ing.id.includes('almond'));
            
            // Plant-based milks should compare to cow milk
            if (hasOats || hasSoy || hasAlmond) return 'milk-product';
            if (hasBeef) return 'beef-product';
            if (hasChicken) return 'chicken-product';
            if (hasPork) return 'pork-product';
            if (hasDairy) return 'cheese-product';
            if (hasCoffee) return 'coffee-product';
            if (hasCocoa) return 'chocolate-product';
            
            // Plant-based default
            return 'beef-product';
        }

        function detectTextileType(ingredients) {
            const hasCotton = ingredients.some(ing => ing.id.includes('cotton'));
            const hasPolyester = ingredients.some(ing => ing.id.includes('polyester'));
            
            if (hasCotton) return 'cotton-tshirt';
            if (hasPolyester) return 'polyester-tshirt';
            
            return 'cotton-tshirt'; // Default
        }

        // ================== UNIVERSAL COMPARISON ENGINE ==================
        function renderUniversalComparisons(myCo2, baseline) {
            const grid = document.getElementById('universalComparisonGrid');
            grid.innerHTML = "";
            
            // Context-aware list
            let list = [];
            if(baseline === UNIVERSAL_BASELINES['milk-product']) {
                list = [
                    {name: "Your Product", val: myCo2, highlight: true},
                    {name: "Cow Milk (Baseline)", val: 1.4},
                    {name: "Almond Milk", val: 0.7},
                    {name: "Soy Milk", val: 0.9}
                ];
            } else if (baseline === UNIVERSAL_BASELINES['beef-product']) {
                list = [
                    {name: "Your Product", val: myCo2, highlight: true},
                    {name: "Beef Burger (Baseline)", val: 32.0},
                    {name: "Chicken Burger", val: 6.0},
                    {name: "Pork Burger", val: 7.5}
                ];
            } else {
                list = [
                    {name: "Your Product", val: myCo2, highlight: true},
                    {name: "Industry Average", val: 5.0}
                ];
            }

            const max = Math.max(...list.map(i=>i.val));

            list.forEach(item => {
                const pct = (item.val / max) * 100;
                grid.innerHTML += `
                    <div class="universal-comparison-item ${item.highlight ? 'highlight' : ''}">
                        <div style="width:150px; font-weight:600; font-size:0.9rem;">${item.name}</div>
                        <div class="bar-container"><div class="bar-fill" style="width:${pct}%"></div></div>
                        <div style="width:80px; text-align:right; font-weight:700;">${item.val.toFixed(2)} kg CO₂e</div>
                    </div>
                `;
            });

            // Update baseline name display
            document.getElementById('baselineName').innerHTML = `<i class="fas fa-robot" style="color: var(--primary);"></i> <strong>Comparing against: ${baseline.name}</strong>`;
        }

        // ================== HARD FINANCIAL MATH ENGINE ==================
        function calculateHardFinancialMath(results, volume, scenarios) {
            const base = currentComparisonBaseline;
            const res = results;
            
            // 1. Carbon Liability (Shadow Price)
            const co2Delta = Math.max(0, base.co2PerKg - res.co2PerKg); // kg savings per unit
            const totalTonsCo2Saved = (co2Delta * volume) / 1000;
            const moneyCarbon = totalTonsCo2Saved * (FINANCIALS.carbon_price * 1000); // Price per ton

            // 2. Logistics Fuel (Weight Physics)
            // Baseline pack weight vs Current pack weight
            const weightDeltaKg = Math.max(0, 0.05 - res.packWeight); // Assume 50g baseline packaging
            const totalWeightSavedTons = (weightDeltaKg * volume) / 1000;
            
            // Determine distance based on scenario
            let distance = scenarios.local ? PHYSICS.transport_dist_local : PHYSICS.transport_dist_std;
            
            // Liters = Tons * km * L/t-km
            const fuelLitersSaved = totalWeightSavedTons * distance * FINANCIALS.logistics_factor;
            const moneyFuel = fuelLitersSaved * FINANCIALS.diesel_price;

            // 3. Energy OPEX (Process Efficiency)
            // Assume baseline uses 0.8 kWh/kg, we calculate our usage
            const baseEnergy = 0.8 * res.finalContentWeight; // per unit
            const myEnergy = res.energyUsed || (res.finalContentWeight * 0.5); // Estimate if not available
            const energyDeltaKwh = Math.max(0, baseEnergy - myEnergy);
            const totalKwhSaved = energyDeltaKwh * volume;
            const moneyEnergy = totalKwhSaved * FINANCIALS.elec_price;

            const total = moneyCarbon + moneyFuel + moneyEnergy;

            return {
                moneyCarbon,
                moneyFuel, 
                moneyEnergy,
                total,
                metrics: {
                    totalTonsCo2Saved,
                    fuelLitersSaved,
                    totalKwhSaved,
                    weightDeltaKg
                }
            };
        }

        // ================== SCENARIO MANAGEMENT ==================
        let activeScenarios = {
            renewables: false,
            local: false,
            lightweight: false
        };

        function toggleScenario(key) {
            activeScenarios[key] = !activeScenarios[key];
            
            // Visual toggle
            const btn = document.getElementById(`scenario-${key}`);
            btn.classList.toggle('active');
            
            // Recalculate everything with new physics
            calculateImpact();
            updateBusinessCase();
        }

        function resetScenarios() {
            activeScenarios = {
                renewables: false,
                local: false,
                lightweight: false
            };
            
            // Reset all scenario buttons
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Recalculate with baseline physics
            calculateImpact();
            updateBusinessCase();
        }

        // ================== BUSINESS CASE INTEGRATION ==================
        function updateHardFinancialLedger(financialResults, volume) {
            const tbody = document.getElementById('ledgerBody');
            const { moneyCarbon, moneyFuel, moneyEnergy, total, metrics } = financialResults;

            tbody.innerHTML = `
                <tr>
                    <td><strong>🛡️ Carbon Liability</strong><br><small>EU ETS Shadow Price (€85/t)</small></td>
                    <td>-${metrics.totalTonsCo2Saved.toFixed(1)} tons CO₂</td>
                    <td class="money-positive">+€${Math.round(moneyCarbon).toLocaleString()}</td>
                </tr>
                <tr>
                    <td><strong>⚡ Energy OPEX</strong><br><small>Efficiency Gain</small></td>
                    <td>-${Math.round(metrics.totalKwhSaved).toLocaleString()} kWh</td>
                    <td class="money-positive">+€${Math.round(moneyEnergy).toLocaleString()}</td>
                </tr>
                <tr>
                    <td><strong>🚚 Logistics Fuel</strong><br><small>Weight reduction savings</small></td>
                    <td>-${Math.round(metrics.fuelLitersSaved).toLocaleString()} L Diesel</td>
                    <td class="money-positive">+€${Math.round(moneyFuel).toLocaleString()}</td>
                </tr>
            `;

            document.getElementById('totalBenefit').innerText = "€" + Math.round(total).toLocaleString();
            
            // Update other business metrics
            document.getElementById('savingsValue').textContent = '€' + formatLargeNumber(total);
            document.getElementById('roiValue').textContent = Math.round((total * 3) / 10000) + '%'; // Simplified ROI
        }

        // ================== EXISTING CODE INTEGRATION ==================
        // Note: The existing PEF calculation engine, ingredient database, and all other 
        // functionality from part 1 remains intact. We're only enhancing the comparison
        // and business case systems.

        // Initialize the enhanced system
        function initEnhancedSystem() {
            // Existing initialization code plus new enhancements
            populateIngredientSelect();
            populateCountrySelect();
            setupDemoData();
            calculateImpact();
            updateTabIndicator();
            
            // Initialize scenario system
            resetScenarios();
        }

        // Enhanced calculateImpact to include universal comparison
        function calculateImpactEnhanced() {
            if(selectedIngredients.length === 0) return;

            // Run existing PEF calculation
            const results = foodCalculationEngine.calculateFoodImpact();
            
            // Add universal comparison
            renderUniversalComparisons(results.co2PerKg, currentComparisonBaseline);
            
            // Update business case with hard financial math
            updateBusinessCase();
            
            return results;
        }

        // Enhanced business case with hard financial math
        function updateBusinessCaseEnhanced() {
            if (!finalPefResults || Object.keys(finalPefResults).length === 0) return;

            const volume = currentAnnualVolume;
            const results = {
                co2PerKg: finalPefResults["Climate Change"].total / massBalanceData.final_content_weight_kg,
                finalContentWeight: massBalanceData.final_content_weight_kg,
                packWeight: parseFloat(document.getElementById('packagingWeight').value)
            };

            // Apply scenario modifications
            if (activeScenarios.lightweight) {
                results.packWeight *= 0.8; // 20% reduction
            }

            const financialResults = calculateHardFinancialMath(results, volume, activeScenarios);
            updateHardFinancialLedger(financialResults, volume);
        }

        // Override existing functions with enhanced versions
        const originalCalculateImpact = calculateImpact;
        const originalUpdateBusinessCase = updateBusinessCase;

        calculateImpact = function() {
            const results = originalCalculateImpact();
            if (results) {
                renderUniversalComparisons(results.co2PerKg, currentComparisonBaseline);
            }
            return results;
        };

        updateBusinessCase = function() {
            originalUpdateBusinessCase();
            updateBusinessCaseEnhanced();
        };

        // ================== UTILITY FUNCTIONS ==================
        function formatLargeNumber(num) {
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(1) + 'B';
            } else if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            } else {
                return Math.round(num).toLocaleString();
            }
        }

        // ================== GLOBAL VARIABLES ==================
        let selectedIngredients = [];
        let currentChart = null;
        let currentBusinessChart = null;
        let currentDPPId = null;
        let finalPefResults = {};
        let massBalanceData = {};
        let auditTrailData = {};
        let currentComparisonBaseline = null;
        let currentAnnualVolume = 10000; // Default volume

        // ================== SCALABLE BUSINESS CASE ENGINE ==================
        function calculateScalableBusinessCase(results, annualVolume) {
            const co2PerKg = results.co2PerKg;
            const baselineCO2PerKg = currentComparisonBaseline ? currentComparisonBaseline.co2PerKg : 30.8;
            const co2Reduction = Math.max(baselineCO2PerKg - co2PerKg, 0);
            const reductionPercentage = (co2Reduction / baselineCO2PerKg) * 100;
            
            // DYNAMIC COST STRUCTURE BASED ON VOLUME
            let implementationCost, carbonPrice, premiumPotential, marketGrowth;
            
            if (annualVolume <= 1000) {
                // Small batch / prototype
                implementationCost = 1000;
                carbonPrice = 30; // Lower carbon price sensitivity
                premiumPotential = reductionPercentage * 0.3; // 0.3% premium per 1% reduction
                marketGrowth = Math.min(reductionPercentage * 1.5, 15);
            } else if (annualVolume <= 10000) {
                // Small business
                implementationCost = 5000;
                carbonPrice = 40;
                premiumPotential = reductionPercentage * 0.4;
                marketGrowth = Math.min(reductionPercentage * 1.8, 20);
            } else if (annualVolume <= 100000) {
                // Medium business
                implementationCost = 20000;
                carbonPrice = 50;
                premiumPotential = reductionPercentage * 0.5;
                marketGrowth = Math.min(reductionPercentage * 2.0, 25);
            } else if (annualVolume <= 1000000) {
                // Large business
                implementationCost = 50000;
                carbonPrice = 60;
                premiumPotential = reductionPercentage * 0.6;
                marketGrowth = Math.min(reductionPercentage * 2.2, 30);
            } else if (annualVolume <= 10000000) {
                // Enterprise
                implementationCost = 200000;
                carbonPrice = 70;
                premiumPotential = reductionPercentage * 0.7;
                marketGrowth = Math.min(reductionPercentage * 2.5, 35);
            } else {
                // Global corporation (millions+)
                implementationCost = 1000000;
                carbonPrice = 80;
                premiumPotential = reductionPercentage * 0.8;
                marketGrowth = Math.min(reductionPercentage * 3.0, 40);
            }
            
            // CALCULATIONS THAT SCALE
            const totalCarbonReduction = co2Reduction * annualVolume;
            const carbonSavings = (totalCarbonReduction * carbonPrice) / 1000; // Convert kg to tons
            
            // Revenue premium scales with volume
            const basePricePerKg = 10; // Assumed base price
            const premiumRevenue = (premiumPotential / 100) * (annualVolume * basePricePerKg);
            
            // Market share growth value
            const totalMarketSize = annualVolume * 10; // Assume 10x current volume as total market
            const marketShareValue = (marketGrowth / 100) * totalMarketSize * basePricePerKg * 0.1; // 10% of new market value
            
            const totalAnnualBenefit = carbonSavings + premiumRevenue + marketShareValue;
            
            // ROI calculation (3-year horizon)
            const roi = annualVolume > 0 ? ((totalAnnualBenefit * 3) - implementationCost) / implementationCost * 100 : 0;
            
            return {
                roi: Math.max(roi, -100), // Cap losses at -100% for display
                annualSavings: carbonSavings,
                premiumRevenue: premiumRevenue,
                marketShareValue: marketShareValue,
                totalAnnualBenefit: totalAnnualBenefit,
                carbonReduction: totalCarbonReduction,
                implementationCost: implementationCost,
                businessScale: getBusinessScale(annualVolume),
                volumeTier: getVolumeTier(annualVolume)
            };
        }

        function getBusinessScale(volume) {
            if (volume <= 1000) return "Prototype / Small Batch";
            if (volume <= 10000) return "Small Business";
            if (volume <= 100000) return "Growing Business";
            if (volume <= 1000000) return "Medium Enterprise";
            if (volume <= 10000000) return "Large Enterprise";
            if (volume <= 100000000) return "Major Corporation";
            return "Global Corporation";
        }

        function getVolumeTier(volume) {
            const tiers = [
                { max: 1000, label: "1-1K" },
                { max: 10000, label: "1K-10K" },
                { max: 100000, label: "10K-100K" },
                { max: 1000000, label: "100K-1M" },
                { max: 10000000, label: "1M-10M" },
                { max: 100000000, label: "10M-100M" },
                { max: 1000000000, label: "100M-1B" },
                { max: 10000000000, label: "1B+" }
            ];
            
            return tiers.find(tier => volume <= tier.max)?.label || "1B+";
        }

        function setVolume(volume) {
            document.getElementById('salesVolume').value = volume;
            updateVolumeDisplay(volume);
            updateBusinessCase();
        }

        function updateVolumeDisplay(volume) {
            currentAnnualVolume = parseInt(volume);
            const display = document.getElementById('volumeDisplay');
            const scaleDisplay = document.getElementById('businessScaleDisplay');
            const tierDisplay = document.getElementById('volumeTierDisplay');
            
            // Format number for display
            if (volume >= 1000000) {
                display.textContent = (volume / 1000000).toFixed(volume >= 10000000 ? 0 : 1) + 'M';
            } else if (volume >= 1000) {
                display.textContent = (volume / 1000).toFixed(volume >= 10000 ? 0 : 1) + 'K';
            } else {
                display.textContent = volume.toLocaleString();
            }
            
            // Update business scale and tier
            const businessCase = calculateScalableBusinessCase({}, volume); // Empty results for scale detection only
            scaleDisplay.textContent = businessCase.businessScale;
            tierDisplay.textContent = businessCase.volumeTier;
        }

        function getBusinessIcon(scale) {
            const icons = {
                "Prototype / Small Batch": "flask",
                "Small Business": "store",
                "Growing Business": "seedling",
                "Medium Enterprise": "building",
                "Large Enterprise": "city",
                "Major Corporation": "globe-americas",
                "Global Corporation": "globe"
            };
            return icons[scale] || "chart-line";
        }

        // ================== AIOXY ALGORITHM IMPLEMENTATION ==================
        const foodCalculationEngine = {
            getDQRQualityLevel(dqrScore) {
                if (dqrScore <= 1.6) return { level: 'Excellent', class: 'dqr-excellent' };
                if (dqrScore <= 2.0) return { level: 'Very Good', class: 'dqr-very-good' };
                if (dqrScore <= 3.0) return { level: 'Good', class: 'dqr-good' };
                if (dqrScore <= 4.0) return { level: 'Fair', class: 'dqr-fair' };
                return { level: 'Poor', class: 'dqr-poor' };
            },

            calculateUncertainty(dqrScore) {
                if (dqrScore <= 1) return 10;
                if (dqrScore <= 2) return 10 + 15 * (dqrScore - 1);
                let base = 25 + 25 * (dqrScore - 2);
                return Math.min(Math.max(base, 10), 100);
            },

            calculateCFFImpact(packaging, weightKg, recycledContentPercent) {
                const A = 0.5;
                const R1 = recycledContentPercent / 100;

                const Ev = packaging.co2_virgin;
                const Er = packaging.co2_recycled;
                const Ed = packaging.co2_disposal;
                const E_avoided = packaging.co2_avoided_credit;
                const R2 = packaging.r2;

                const materialBurden = (1 - R1) * Ev + R1 * Er;
                const disposalBurden = (1 - R2) * Ed;
                const recyclingCredit = R2 * E_avoided * A;

                const endOfLife = disposalBurden - recyclingCredit;
                const totalPerKg = materialBurden + endOfLife;

                return {
                    totalImpact: totalPerKg * weightKg,
                    materialBurden: materialBurden * weightKg,
                    endOfLifeBurden: endOfLife * weightKg,
                    cff_parameters: { A, R1, R2, Ev, Er, Ed, E_avoided }
                };
            },

            calculateFoodImpact() {
                // Get inputs from DOM
                const productName = document.getElementById('productName').value || 'Unnamed Product';
                const manufacturingCountryCode = document.getElementById('manufacturingCountry').value || 'FR';
                const processingMethod = document.getElementById('processingMethod').value;
                const transportDistance = parseFloat(document.getElementById('transportDistance').value) || 0;
                const transportMode = document.getElementById('transportMode').value;
                const refrigeratedTransport = document.getElementById('refrigeratedTransport').value === 'yes';
                const packagingMaterial = document.getElementById('packagingMaterial').value;
                const packagingWeight = parseFloat(document.getElementById('packagingWeight').value) || 0;
                const recycledContentPercent = parseFloat(document.getElementById('recycledContent').value) || 0;

                // SMART CATEGORY DETECTION
                const productCategory = document.getElementById('productCategory').value;
                const comparisonKey = detectProductCategory(productName, selectedIngredients, productCategory);
                const comparisonBaseline = UNIVERSAL_BASELINES[comparisonKey];
                currentComparisonBaseline = comparisonBaseline;

                // Auto-apply oat processing for oat milk products
                let finalProcessingMethod = processingMethod;
                if (productName.toLowerCase().includes('oat milk') && processingMethod === 'none') {
                    finalProcessingMethod = 'oat-processing';
                    document.getElementById('processingMethod').value = 'oat-processing';
                }

                // Data fallbacks
                const country = aioxyData.countries[manufacturingCountryCode] || aioxyData.countries.FR;
                const processing = aioxyData.processing[finalProcessingMethod] || aioxyData.processing.none;
                const transport = aioxyData.transportation[transportMode] || aioxyData.transportation.road;
                const packaging = aioxyData.packaging[packagingMaterial] || aioxyData.packaging.cardboard;
                const awareFactor = country.awareFactor;

                // Initialize audit trail
                const auditTrail = {
                    productName,
                    dppId: 'TRC-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                    calculationTimestamp: new Date().toISOString(),
                    pefCategories: {},
                    mass_balance: {},
                    dqr_summary: {},
                    uncertainty_analysis: {},
                    comparison_baseline: comparisonBaseline
                };

                // Initialize all 16 categories
                Object.keys(aioxyData.pefCategories).forEach(cat => {
                    auditTrail.pefCategories[cat] = {
                        total: 0,
                        unit: aioxyData.pefCategories[cat].unit,
                        contribution_tree: {
                            Ingredients: { total: 0, components: [] },
                            Manufacturing: { total: 0, components: [] },
                            Transport: { total: 0, components: [] },
                            Packaging: { total: 0, components: [] }
                        }
                    };
                });

                // 1. INGREDIENTS + MASS BALANCE
                let totalIngredientQuantity = 0;
                let totalInputQuantity = 0;
                let agriculturalLoss = 0;
                let dqrComponents = [];

                selectedIngredients.forEach(item => {
                    const ingredient = aioxyData.ingredients[item.id];
                    if (!ingredient) return;

                    const adjustedQuantity = item.quantity / (1 - (ingredient.loss || 0));
                    agriculturalLoss += adjustedQuantity * (ingredient.loss || 0);

                    totalIngredientQuantity += item.quantity;
                    totalInputQuantity += adjustedQuantity;

                    const dqr = ingredient.data.metadata.dqr_overall;
                    const uncertainty = this.calculateUncertainty(ingredient.data.metadata.dqr.P);

                    dqrComponents.push({
                        name: ingredient.name,
                        dqr,
                        uncertainty,
                        weight: item.quantity,
                        source: ingredient.data.metadata.source_dataset
                    });

                    Object.keys(aioxyData.pefCategories).forEach(cat => {
                        const impact = ingredient.data.pef[cat] || 0;
                        const subtotal = adjustedQuantity * impact;

                        auditTrail.pefCategories[cat].contribution_tree.Ingredients.components.push({
                            name: ingredient.name,
                            id: item.id,
                            quantity_kg: adjustedQuantity,
                            subtotal: subtotal,
                            source: ingredient.data.metadata.source_dataset,
                            dqr,
                            uncertainty
                        });

                        auditTrail.pefCategories[cat].contribution_tree.Ingredients.total += subtotal;
                        auditTrail.pefCategories[cat].total += subtotal;
                    });
                });

                // DQR & uncertainty
                const overallDQR = dqrComponents.length > 0 ? 
                    dqrComponents.reduce((sum, c) => sum + c.dqr * c.weight, 0) / totalIngredientQuantity : 0;

                auditTrail.dqr_summary = {
                    overall_dqr: overallDQR,
                    dqr_level: this.getDQRQualityLevel(overallDQR).level,
                    component_dqrs: dqrComponents
                };

                auditTrail.uncertainty_analysis = {
                    overall_uncertainty: this.calculateUncertainty(overallDQR),
                    component_uncertainties: dqrComponents.map(c => ({ name: c.name, uncertainty: c.uncertainty }))
                };

                // Mass balance
                const finalContentWeight = totalIngredientQuantity * processing.yield;
                const processingLoss = totalIngredientQuantity - finalContentWeight;

                auditTrail.mass_balance = {
                    raw_input_total_kg: totalInputQuantity,
                    agricultural_processing_loss_kg: agriculturalLoss,
                    after_agricultural_loss_kg: totalIngredientQuantity,
                    processing_loss_kg: processingLoss,
                    final_content_weight_kg: finalContentWeight,
                    packaging_weight_kg: packagingWeight,
                    total_product_weight_kg: finalContentWeight + packagingWeight,
                    balance_check: totalInputQuantity - agriculturalLoss - processingLoss - finalContentWeight
                };

                // 2. MANUFACTURING / PROCESSING
                const processingCO2 = processing.co2_impact * totalIngredientQuantity;
                const processingWaterRaw = processing.water_impact * totalIngredientQuantity;
                const processingWaterScarcity = processingWaterRaw * awareFactor;

                // Climate Change
                auditTrail.pefCategories["Climate Change"].contribution_tree.Manufacturing.total += processingCO2;
                auditTrail.pefCategories["Climate Change"].total += processingCO2;
                auditTrail.pefCategories["Climate Change"].contribution_tree.Manufacturing.components.push({
                    name: `Processing - ${finalProcessingMethod}`,
                    subtotal: processingCO2
                });

                // Water Scarcity (AWARE)
                auditTrail.pefCategories["Water Use/Scarcity (AWARE)"].contribution_tree.Manufacturing.total += processingWaterScarcity;
                auditTrail.pefCategories["Water Use/Scarcity (AWARE)"].total += processingWaterScarcity;
                auditTrail.pefCategories["Water Use/Scarcity (AWARE)"].contribution_tree.Manufacturing.components.push({
                    name: `Processing - ${finalProcessingMethod}`,
                    raw_water_m3: processingWaterRaw,
                    aware_factor: awareFactor,
                    subtotal: processingWaterScarcity
                });

                // 3. TRANSPORT
                let transportCO2 = transportDistance * transport.co2 * (finalContentWeight / 1000);

                if (refrigeratedTransport) {
                    transportCO2 *= (1 + transport.refrigerated_factor);
                }

                auditTrail.pefCategories["Climate Change"].contribution_tree.Transport.total += transportCO2;
                auditTrail.pefCategories["Climate Change"].total += transportCO2;
                auditTrail.pefCategories["Climate Change"].contribution_tree.Transport.components.push({
                    name: `Transport - ${transportMode}`,
                    distance_km: transportDistance,
                    refrigerated: refrigeratedTransport,
                    subtotal: transportCO2
                });

                // 4. PACKAGING (CFF)
                const cffResult = this.calculateCFFImpact(packaging, packagingWeight, recycledContentPercent);

                auditTrail.pefCategories["Climate Change"].contribution_tree.Packaging.total += cffResult.totalImpact;
                auditTrail.pefCategories["Climate Change"].total += cffResult.totalImpact;
                auditTrail.pefCategories["Climate Change"].contribution_tree.Packaging.components.push({
                    name: `${packagingMaterial} packaging`,
                    weight_kg: packagingWeight,
                    recycled_content: recycledContentPercent,
                    subtotal: cffResult.totalImpact
                });

                // Save results
                auditTrailData = auditTrail;
                finalPefResults = auditTrail.pefCategories;
                massBalanceData = auditTrail.mass_balance;
                currentDPPId = auditTrail.dppId;

                // Calculate comparison
                const baselineCO2 = comparisonBaseline.co2PerKg * finalContentWeight;
                const baselineWater = comparisonBaseline.waterPerKg * finalContentWeight;
                const currentCO2 = auditTrail.pefCategories["Climate Change"].total;
                const currentWater = auditTrail.pefCategories["Water Use/Scarcity (AWARE)"].total;

                const co2Saved = Math.max(baselineCO2 - currentCO2, 0);
                const waterSaved = Math.max(baselineWater - currentWater, 0);

                return {
                    finalPefResults: auditTrail.pefCategories,
                    auditTrail: auditTrail,
                    massBalance: auditTrail.mass_balance,
                    overallDQR,
                    overallUncertainty: auditTrail.uncertainty_analysis.overall_uncertainty,
                    finalContentWeight,
                    totalProductWeight: finalContentWeight + packagingWeight,
                    co2PerKg: auditTrail.pefCategories["Climate Change"].total / finalContentWeight,
                    waterScarcityPerKg: auditTrail.pefCategories["Water Use/Scarcity (AWARE)"].total / finalContentWeight,
                    landUsePerKg: auditTrail.pefCategories["Land Use"].total / finalContentWeight,
                    fossilPerKg: auditTrail.pefCategories["Resource Use, fossils"].total / finalContentWeight,
                    comparison: {
                        baseline: comparisonBaseline,
                        co2Saved,
                        waterSaved,
                        co2SavedPerKg: co2Saved / finalContentWeight,
                        waterSavedPerKg: waterSaved / finalContentWeight
                    }
                };
            }
        };

        // ================== BUSINESS CASE CALCULATOR ==================
        function updateBusinessCase() {
            if (!finalPefResults || Object.keys(finalPefResults).length === 0) {
                document.getElementById('businessStory').innerHTML = `
                    <div class="story-highlight">
                        <i class="fas fa-calculator"></i>
                        <strong>Calculate environmental impacts first</strong> to see the complete business case
                    </div>
                `;
                return;
            }

            const results = {
                co2PerKg: finalPefResults["Climate Change"].total / massBalanceData.final_content_weight_kg,
                finalContentWeight: massBalanceData.final_content_weight_kg
            };

            const businessCase = calculateScalableBusinessCase(results, currentAnnualVolume);

            // UPDATE ALL 4 BUSINESS PILLARS
document.getElementById('roiValue').textContent = businessCase.roi.toFixed(0) + '%';
document.getElementById('savingsValue').textContent = '€' + formatLargeNumber(businessCase.annualSavings);
document.getElementById('premiumValue').textContent = businessCase.premiumPotential.toFixed(1) + '%';
document.getElementById('marketValue').textContent = businessCase.marketGrowth.toFixed(1) + '%';

            // UPDATE COST BREAKDOWN
            document.getElementById('implementationCost').textContent = '€' + formatLargeNumber(businessCase.implementationCost);
            document.getElementById('carbonReductionDisplay').textContent = formatLargeNumber(businessCase.carbonReduction) + ' kg CO₂e';
            document.getElementById('totalBenefitDisplay').textContent = '€' + formatLargeNumber(businessCase.totalAnnualBenefit);
            document.getElementById('netReturnDisplay').textContent = '€' + formatLargeNumber((businessCase.totalAnnualBenefit * 3) - businessCase.implementationCost);

            // UPDATE ROI BADGE WITH DYNAMIC COLORS
            const roiBadge = document.getElementById('roiBadge');
            if (businessCase.roi >= 200) {
                roiBadge.textContent = 'EXCEPTIONAL ROI';
                roiBadge.style.background = 'var(--dqr-excellent)';
            } else if (businessCase.roi >= 100) {
                roiBadge.textContent = 'EXCELLENT ROI';
                roiBadge.style.background = 'var(--dqr-very-good)';
            } else if (businessCase.roi >= 50) {
                roiBadge.textContent = 'STRONG ROI';
                roiBadge.style.background = 'var(--dqr-good)';
            } else if (businessCase.roi >= 20) {
                roiBadge.textContent = 'GOOD ROI';
                roiBadge.style.background = 'var(--dqr-fair)';
            } else if (businessCase.roi >= 0) {
                roiBadge.textContent = 'MODEST ROI';
                roiBadge.style.background = 'var(--dqr-poor)';
            } else {
                roiBadge.textContent = 'NEGATIVE ROI';
                roiBadge.style.background = 'var(--accent)';
            }

            // UPDATE BUSINESS STORY WITH ALL 4 PILLARS
            document.getElementById('businessStory').innerHTML = `
                <div class="story-highlight">
                    <i class="fas fa-${getBusinessIcon(businessCase.businessScale)}"></i>
                    <strong>${businessCase.businessScale} Opportunity</strong><br>
                    At ${currentAnnualVolume.toLocaleString()} units annually, sustainability creates 
                    <strong>€${formatLargeNumber(businessCase.totalAnnualBenefit)}</strong> in annual business value.
                </div>
                <p>
                    <strong>💰 Carbon Savings:</strong> €${formatLargeNumber(businessCase.annualSavings)}<br>
                    <strong>📈 Price Premium Revenue:</strong> €${formatLargeNumber(businessCase.premiumRevenue)}<br>  
                    <strong>👥 Market Share Growth:</strong> €${formatLargeNumber(businessCase.marketShareValue)}<br>
                    <strong>🎯 Total Annual Benefit:</strong> €${formatLargeNumber(businessCase.totalAnnualBenefit)}
                </p>
                <div class="story-highlight">
                    <i class="fas fa-bullseye"></i>
                    <strong>Market Leadership Potential:</strong> 
                    Your environmental advantage positions you for significant market share capture in the growing sustainable products category.
                </div>
            `;
        }

        // ================== ENHANCED STORYTELLING ==================
        function getProductTypeDescription() {
            const productName = document.getElementById('productName').value.toLowerCase();
            if (productName.includes('shampoo') || productName.includes('conditioner')) return 'personal care product';
            if (productName.includes('soap') || productName.includes('lotion')) return 'personal care product';
            if (productName.includes('tshirt') || productName.includes('shirt')) return 'clothing item';
            if (productName.includes('coffee')) return 'coffee product';
            if (productName.includes('chocolate')) return 'chocolate product';
            return 'product';
        }

        function getPerformanceLevel(currentCO2, baselineCO2) {
            const reduction = ((baselineCO2 - currentCO2) / baselineCO2) * 100;
            if (reduction >= 50) return 'outstanding';
            if (reduction >= 30) return 'excellent';
            if (reduction >= 15) return 'strong';
            if (reduction >= 5) return 'good';
            return 'modest';
        }

        function getCustomMessage(baselineName, currentCO2) {
            const messages = {
                'Conventional Beef Product': `This represents a major step forward in sustainable food production.`,
                'Conventional Chicken Product': `Your approach shows clear environmental advantages over conventional poultry.`,
                'Conventional Pork Product': `Significant resource savings demonstrate your commitment to sustainability.`,
                'Conventional Cheese Product': `Innovative approach delivering both taste and environmental benefits.`,
                'Conventional Coffee Product': `Sustainable sourcing practices protect ecosystems while delivering great flavor.`,
                'Conventional Chocolate Product': `Ethical and environmental considerations make this a responsible choice.`,
                'Conventional Shampoo': `Natural ingredients and sustainable formulation set a new standard.`,
                'Conventional Soap': `Eco-friendly composition reduces environmental impact significantly.`,
                'Conventional Cotton T-Shirt': `Sustainable textiles contribute to a cleaner fashion industry.`,
                'Conventional Soda Drink': `Reduced environmental footprint in every serving.`
            };
            return messages[baselineName] || `This achievement reflects thoughtful ingredient selection and efficient supply chain management.`;
        }

        // ================== INITIALIZATION ==================
        function initApp() {
            populateIngredientSelect();
            populateCountrySelect();
            setupDemoData();
            calculateImpact();
            updateTabIndicator();
        }

        function populateIngredientSelect() {
            const select = document.getElementById('ingredientSelect');
            select.innerHTML = '<option value="">Choose from science-based ingredients...</option>';
            
            for (const [key, ingredient] of Object.entries(aioxyData.ingredients)) {
                const option = document.createElement('option');
                option.value = key;
                const dqrQuality = foodCalculationEngine.getDQRQualityLevel(ingredient.data.metadata.dqr_overall);
                option.textContent = `${ingredient.name} (${dqrQuality.level} DQR)`;
                select.appendChild(option);
            }
        }

        function populateCountrySelect() {
            const select = document.getElementById('manufacturingCountry');
            select.innerHTML = '<option value="">Select country...</option>';
            
            for (const [code, country] of Object.entries(aioxyData.countries)) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = country.name;
                if (code === 'FR') option.selected = true;
                select.appendChild(option);
            }
        }

        function setupDemoData() {
            selectedIngredients = [
                { id: 'peas-eu-dried', name: aioxyData.ingredients['peas-eu-dried'].name, quantity: 0.15 },
                { id: 'wheat-eu-conv', name: aioxyData.ingredients['wheat-eu-conv'].name, quantity: 0.10 },
                { id: 'tomatoes-es-field', name: aioxyData.ingredients['tomatoes-es-field'].name, quantity: 0.05 }
            ];
            updateIngredientList();
        }

        // ================== INGREDIENT MANAGEMENT ==================
        function addIngredient() {
            const select = document.getElementById('ingredientSelect');
            const quantityInput = document.getElementById('ingredientQuantity');
            
            const ingredientId = select.value;
            const quantity = parseFloat(quantityInput.value);
            
            if (!ingredientId || isNaN(quantity) || quantity <= 0) {
                alert('Please select an ingredient and enter a valid quantity');
                return;
            }
            
            const ingredient = aioxyData.ingredients[ingredientId];
            selectedIngredients.push({
                id: ingredientId,
                name: ingredient.name,
                quantity: quantity
            });
            
            updateIngredientList();
            calculateImpact();
            
            select.value = '';
            quantityInput.value = '0.150';
        }

        function removeIngredient(index) {
            selectedIngredients.splice(index, 1);
            updateIngredientList();
            calculateImpact();
        }

        function updateIngredientList() {
            const list = document.getElementById('ingredientList');
            list.innerHTML = '';
            
            if (selectedIngredients.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-apple-alt"></i>
                        <h3>No ingredients added yet</h3>
                        <p>Add ingredients to calculate your environmental impact</p>
                    </div>
                `;
                return;
            }
            
            selectedIngredients.forEach((ingredient, index) => {
                const ingredientData = aioxyData.ingredients[ingredient.id];
                const dqrQuality = foodCalculationEngine.getDQRQualityLevel(ingredientData.data.metadata.dqr_overall);
                const uncertainty = foodCalculationEngine.calculateUncertainty(ingredientData.data.metadata.dqr.P);
                
                const item = document.createElement('div');
                item.className = 'ingredient-item';
                item.innerHTML = `
                    <div class="ingredient-info">
                        <div class="ingredient-name">${ingredient.name}</div>
                        <div class="ingredient-stats">
                            ${ingredientData.data.pef["Climate Change"]} kg CO₂e/kg • 
                            ${ingredientData.data.pef["Water Use/Scarcity (AWARE)"]} m³ water/kg •
                            <span class="dqr-badge ${dqrQuality.class}">DQR: ${dqrQuality.level}</span>
                            <span class="badge" style="margin-left: 0.5rem;">±${uncertainty}% uncertainty</span>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span class="source-badge">${ingredientData.data.metadata.source_dataset}</span>
                        </div>
                    </div>
                    <div class="ingredient-actions">
                        <input type="number" class="quantity-input" value="${ingredient.quantity}" step="0.001" min="0" 
                               onchange="updateIngredientQuantity(${index}, this.value)">
                        <button class="remove-btn" onclick="removeIngredient(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function updateIngredientQuantity(index, newQuantity) {
            selectedIngredients[index].quantity = parseFloat(newQuantity);
            calculateImpact();
        }

        function toggleAdvanced() {
            const advanced = document.getElementById('advancedOptions');
            advanced.classList.toggle('hidden');
        }

        function updateComparison() {
            calculateImpact();
        }

        // ================== TAB MANAGEMENT ==================
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            event.currentTarget.classList.add('active');
            
            if (tabName === 'results') calculateImpact();
            if (tabName === 'business-case') updateBusinessCase();
            if (tabName === 'dpp') generateDPP();
            if (tabName === 'pef-scorecard') displayFullPefScorecard();
            if (tabName === 'transparency') displayAuditTrail();
            
            updateTabIndicator();
        }

        function updateTabIndicator() {
            const activeTab = document.querySelector('.nav-tab.active');
            const indicator = document.getElementById('tabIndicator');
            
            if (activeTab && indicator) {
                indicator.style.left = activeTab.offsetLeft + 'px';
                indicator.style.width = activeTab.offsetWidth + 'px';
            }
        }

        // ================== CORE CALCULATION ENGINE ==================
        function calculateImpact() {
            if (selectedIngredients.length === 0) {
                clearResults();
                return;
            }

            const loadingElement = document.getElementById('loadingResults');
            const resultsContent = document.getElementById('resultsContent');
            
            loadingElement.classList.remove('hidden');
            resultsContent.classList.add('hidden');

            setTimeout(() => {
                const results = foodCalculationEngine.calculateFoodImpact();
                updateResultsUI(results);
                
                loadingElement.classList.add('hidden');
                resultsContent.classList.remove('hidden');
            }, 800);
        }

        function clearResults() {
            document.getElementById('co2Value').textContent = '0.00 kg';
            document.getElementById('waterValue').textContent = '0 m³';
            document.getElementById('landValue').textContent = '0 Pt';
            document.getElementById('fossilValue').textContent = '0 MJ';
            
            document.getElementById('co2Savings').textContent = '0% saved';
            document.getElementById('waterSavings').textContent = '0% saved';

            document.getElementById('carKm').textContent = '0 km';
            document.getElementById('householdEnergy').textContent = '0 days';
            document.getElementById('treesPlanted').textContent = '0 trees';
            document.getElementById('waterBottles').textContent = '0 bottles';

            document.getElementById('environmentalStory').classList.add('hidden');
            document.getElementById('massBalanceSection').classList.add('hidden');
            document.getElementById('dataQualitySection').classList.add('hidden');
            document.getElementById('multiComparisonSection').classList.add('hidden');

            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
        }

        function updateResultsUI(results) {
            updateMassBalanceDisplay();
            updateDataQualityDisplay(results);
            updateEnvironmentalStory(results);
            updateMultiComparison(results.co2PerKg, currentComparisonBaseline.category);

            document.getElementById('co2Value').textContent = results.co2PerKg.toFixed(2) + ' kg';
            document.getElementById('waterValue').textContent = results.waterScarcityPerKg.toFixed(2) + ' m³';
            document.getElementById('landValue').textContent = results.landUsePerKg.toFixed(0) + ' Pt';
            document.getElementById('fossilValue').textContent = results.fossilPerKg.toFixed(1) + ' MJ';
            
            // Calculate savings compared to baseline
            const baselineCO2 = currentComparisonBaseline ? currentComparisonBaseline.co2PerKg : 30.8;
            const baselineWater = currentComparisonBaseline ? currentComparisonBaseline.waterPerKg : 8.1;
            
            const co2SavingsPercent = ((baselineCO2 - results.co2PerKg) / baselineCO2 * 100).toFixed(1);
            const waterSavingsPercent = ((baselineWater - results.waterScarcityPerKg) / baselineWater * 100).toFixed(1);
            
            document.getElementById('co2Savings').textContent = Math.max(co2SavingsPercent, 0) + '% saved vs ' + (currentComparisonBaseline ? currentComparisonBaseline.name.toLowerCase() : 'beef');
            document.getElementById('waterSavings').textContent = Math.max(waterSavingsPercent, 0) + '% saved vs ' + (currentComparisonBaseline ? currentComparisonBaseline.name.toLowerCase() : 'beef');

            // Storytelling comparisons
            const co2Saved = results.comparison.co2Saved;
            const waterSaved = results.comparison.waterSaved;
            
            document.getElementById('carKm').textContent = Math.round(co2Saved * 1000 / 120) + ' km';
            document.getElementById('householdEnergy').textContent = (co2Saved * 1000 / 12000).toFixed(1) + ' days';
            document.getElementById('treesPlanted').textContent = Math.round(co2Saved / 0.025) + ' trees';
            document.getElementById('waterBottles').textContent = Math.round(waterSaved * 1000 / 1.5) + ' bottles';

            createEmissionChart(results);
        }

        function updateEnvironmentalStory(results) {
            const environmentalStory = document.getElementById('environmentalStory');
            const storyContent = document.getElementById('storyContent');
            const storyComparison = document.getElementById('storyComparison');

            const co2Saved = results.comparison.co2Saved;
            const waterSaved = results.comparison.waterSaved;
            const carKm = Math.round(co2Saved * 1000 / 120);
            const trees = Math.round(co2Saved / 0.025);

            environmentalStory.classList.remove('hidden');
            
            storyContent.innerHTML = `
                <div class="story-highlight">
                    <i class="fas fa-seedling"></i>
                    <strong>${co2Saved.toFixed(1)} kg CO₂e saved vs ${results.comparison.baseline.name}</strong> - equivalent to not driving ${carKm} km in a standard car
                </div>
                <div class="story-highlight">
                    <i class="fas fa-tree"></i>
                    <strong>Carbon absorption equivalent to ${trees} trees</strong> - making a real contribution to natural carbon capture
                </div>
                <p>
                    Your ${getProductTypeDescription()} demonstrates <strong>${getPerformanceLevel(results.co2PerKg, results.comparison.baseline.co2PerKg)} environmental performance</strong> with a carbon footprint 
                    ${((results.comparison.baseline.co2PerKg - results.co2PerKg) / results.comparison.baseline.co2PerKg * 100).toFixed(1)}% lower than ${results.comparison.baseline.name}. 
                    ${getCustomMessage(results.comparison.baseline.name, results.co2PerKg)}
                </p>
            `;

            storyComparison.innerHTML = `
                <div class="story-item">
                    <div class="story-icon">🚗</div>
                    <div class="story-value">${carKm} km</div>
                    <div class="story-label">Car driving equivalent saved</div>
                </div>
                <div class="story-item">
                    <div class="story-icon">🏠</div>
                    <div class="story-value">${(co2Saved * 1000 / 12000).toFixed(1)} days</div>
                    <div class="story-label">Home energy equivalent</div>
                </div>
                <div class="story-item">
                    <div class="story-icon">🌳</div>
                    <div class="story-value">${trees}</div>
                    <div class="story-label">Trees for saved CO₂</div>
                </div>
                <div class="story-item">
                    <div class="story-icon">💧</div>
                    <div class="story-value">${Math.round(waterSaved * 1000 / 1.5)}</div>
                    <div class="story-label">Water bottles saved</div>
                </div>
            `;
        }

        function updateDataQualityDisplay(results) {
            const dataQualitySection = document.getElementById('dataQualitySection');
            const dqrBreakdown = document.getElementById('dqrBreakdown');
            const overallDQRBadge = document.getElementById('overallDQRBadge');
            
            if (auditTrailData.dqr_summary && auditTrailData.dqr_summary.component_dqrs.length > 0) {
                dataQualitySection.classList.remove('hidden');
                
                // Calculate average DQR factors
                let terSum = 0, grSum = 0, tirSum = 0, cSum = 0, pSum = 0;
                let count = 0;
                
                auditTrailData.dqr_summary.component_dqrs.forEach(score => {
                    const ingredient = aioxyData.ingredients[selectedIngredients.find(i => i.name === score.name)?.id];
                    if (ingredient) {
                        terSum += ingredient.data.metadata.dqr.TeR;
                        grSum += ingredient.data.metadata.dqr.GR;
                        tirSum += ingredient.data.metadata.dqr.TiR;
                        cSum += ingredient.data.metadata.dqr.C;
                        pSum += ingredient.data.metadata.dqr.P;
                        count++;
                    }
                });
                
                const avgFactors = {
                    TeR: (terSum / count).toFixed(1),
                    GR: (grSum / count).toFixed(1),
                    TiR: (tirSum / count).toFixed(1),
                    C: (cSum / count).toFixed(1),
                    P: (pSum / count).toFixed(1)
                };
                
                dqrBreakdown.innerHTML = `
                    <div class="dqr-factor">
                        <div class="dqr-factor-value">${avgFactors.TeR}</div>
                        <div class="dqr-factor-label">TeR</div>
                        <div style="font-size: 0.7rem; margin-top: 0.5rem;">Technological Representativeness</div>
                    </div>
                    <div class="dqr-factor">
                        <div class="dqr-factor-value">${avgFactors.GR}</div>
                        <div class="dqr-factor-label">GR</div>
                        <div style="font-size: 0.7rem; margin-top: 0.5rem;">Geographical Representativeness</div>
                    </div>
                    <div class="dqr-factor">
                        <div class="dqr-factor-value">${avgFactors.TiR}</div>
                        <div class="dqr-factor-label">TiR</div>
                        <div style="font-size: 0.7rem; margin-top: 0.5rem;">Time Representativeness</div>
                    </div>
                    <div class="dqr-factor">
                        <div class="dqr-factor-value">${avgFactors.C}</div>
                        <div class="dqr-factor-label">C</div>
                        <div style="font-size: 0.7rem; margin-top: 0.5rem;">Completeness</div>
                    </div>
                    <div class="dqr-factor">
                        <div class="dqr-factor-value">${avgFactors.P}</div>
                        <div class="dqr-factor-label">P</div>
                        <div style="font-size: 0.7rem; margin-top: 0.5rem;">Parameter Uncertainty</div>
                    </div>
                `;
                
                const dqrQuality = foodCalculationEngine.getDQRQualityLevel(results.overallDQR);
                overallDQRBadge.className = `dqr-badge ${dqrQuality.class}`;
                overallDQRBadge.innerHTML = `<i class="fas fa-star"></i> Overall Data Quality: ${dqrQuality.level} (DQR: ${results.overallDQR.toFixed(1)}) • ±${results.overallUncertainty}% uncertainty`;
            } else {
                dataQualitySection.classList.add('hidden');
            }
        }

        function updateMassBalanceDisplay() {
            const massBalanceSection = document.getElementById('massBalanceSection');
            const massBalanceContent = document.getElementById('massBalanceContent');
            
            if (massBalanceData.raw_input_total_kg > 0) {
                massBalanceSection.classList.remove('hidden');
                
                const balanceDifference = Math.abs(massBalanceData.balance_check);
                const balanceStatus = balanceDifference < 0.001 ? "✅ Balanced" : "⚠️ Check Required";
                
                massBalanceContent.innerHTML = `
                    <div class="mass-balance-item">
                        <span>Total Input Weight:</span>
                        <span>${massBalanceData.raw_input_total_kg.toFixed(3)} kg</span>
                    </div>
                    <div class="mass-balance-item">
                        <span>Agricultural Loss:</span>
                        <span>- ${massBalanceData.agricultural_processing_loss_kg.toFixed(3)} kg</span>
                    </div>
                    <div class="mass-balance-item">
                        <span>Processing Loss:</span>
                        <span>- ${massBalanceData.processing_loss_kg.toFixed(3)} kg</span>
                    </div>
                    <div class="mass-balance-item">
                        <span>Final Product Weight:</span>
                        <span>${massBalanceData.final_content_weight_kg.toFixed(3)} kg</span>
                    </div>
                    <div class="mass-balance-item">
                        <span>Mass Balance:</span>
                        <span>${balanceStatus}</span>
                    </div>
                `;
            } else {
                massBalanceSection.classList.add('hidden');
            }
        }

        // ================== PEF SCORECARD ==================
        function displayFullPefScorecard() {
            const tbody = document.getElementById('pefScorecardBody');
            const ingredientDataQuality = document.getElementById('ingredientDataQuality');
            tbody.innerHTML = '';
            
            const totalWeight = massBalanceData.final_content_weight_kg || 0.2;
            
            for (const category in finalPefResults) {
                const row = document.createElement('tr');
                const unit = aioxyData.pefCategories[category].unit;
                const perKgValue = totalWeight > 0 ? finalPefResults[category].total / totalWeight : 0;
                
                let displayValue = formatPEFValue(finalPefResults[category].total);
                let perKgDisplay = formatPEFValue(perKgValue);
                
                const categoryUncertainty = auditTrailData.uncertainty_analysis?.overall_uncertainty || 15;
                const dqrQuality = foodCalculationEngine.getDQRQualityLevel(auditTrailData.dqr_summary?.overall_dqr || 1.5);
                
                row.innerHTML = `
                    <td class="pef-category">${category}</td>
                    <td class="pef-value">${displayValue}</td>
                    <td class="pef-unit">${unit}</td>
                    <td class="pef-value">${perKgDisplay}</td>
                    <td>
                        <span class="dqr-badge ${dqrQuality.class}">
                            <i class="fas fa-star"></i>
                            ${dqrQuality.level}
                        </span>
                    </td>
                    <td class="pef-value">±${categoryUncertainty}%</td>
                `;
                tbody.appendChild(row);
            }
            
            // Display ingredient data quality
            if (auditTrailData.dqr_summary && auditTrailData.dqr_summary.component_dqrs) {
                let qualityHTML = '';
                auditTrailData.dqr_summary.component_dqrs.forEach(score => {
                    const dqrQuality = foodCalculationEngine.getDQRQualityLevel(score.dqr);
                    qualityHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border);">
                            <div>
                                <strong>${score.name}</strong>
                                <div style="font-size: 0.8rem; color: var(--gray);">${score.source}</div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span class="dqr-badge ${dqrQuality.class}">DQR: ${score.dqr.toFixed(1)}</span>
                                <span class="badge">±${score.uncertainty}% uncertainty</span>
                            </div>
                        </div>
                    `;
                });
                ingredientDataQuality.innerHTML = qualityHTML;
            }
        }

        // ================== TRANSPARENCY LOG ==================
        function displayAuditTrail() {
            const auditContent = document.getElementById('auditTrailContent');
            
            if (!auditTrailData || !auditTrailData.pefCategories) {
                auditContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calculator"></i>
                        <h3>No calculation data available</h3>
                        <p>Calculate environmental impacts first to generate the transparency log</p>
                    </div>
                `;
                return;
            }

            let auditHTML = '';
            
            // Display key categories with detailed breakdown
            const keyCategories = ["Climate Change", "Water Use/Scarcity (AWARE)", "Land Use", "Resource Use, fossils"];
            
            keyCategories.forEach(category => {
                if (auditTrailData.pefCategories[category]) {
                    const cat = auditTrailData.pefCategories[category];
                    auditHTML += `
                        <div class="audit-category">
                            <div class="audit-category-header">
                                <span>${category}</span>
                                <span class="pef-value">${formatPEFValue(cat.total)} ${cat.unit}</span>
                            </div>
                            
                            <div class="audit-component">
                                <div class="audit-component-header">
                                    <span>Ingredients</span>
                                    <span>${formatPEFValue(cat.contribution_tree.Ingredients.total)} ${cat.unit}</span>
                                </div>
                                ${cat.contribution_tree.Ingredients.components.map(comp => `
                                    <div class="audit-item">
                                        <span class="audit-item-name">${comp.name}</span>
                                        <span class="audit-item-value">${formatPEFValue(comp.subtotal)} ${cat.unit}</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${cat.contribution_tree.Manufacturing.total > 0 ? `
                            <div class="audit-component">
                                <div class="audit-component-header">
                                    <span>Manufacturing</span>
                                    <span>${formatPEFValue(cat.contribution_tree.Manufacturing.total)} ${cat.unit}</span>
                                </div>
                                ${cat.contribution_tree.Manufacturing.components.map(comp => `
                                    <div class="audit-item">
                                        <span class="audit-item-name">${comp.name}</span>
                                        <span class="audit-item-value">${formatPEFValue(comp.subtotal)} ${cat.unit}</span>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                            
                            ${cat.contribution_tree.Transport.total > 0 ? `
                            <div class="audit-component">
                                <div class="audit-component-header">
                                    <span>Transport</span>
                                    <span>${formatPEFValue(cat.contribution_tree.Transport.total)} ${cat.unit}</span>
                                </div>
                                ${cat.contribution_tree.Transport.components.map(comp => `
                                    <div class="audit-item">
                                        <span class="audit-item-name">${comp.name}</span>
                                        <span class="audit-item-value">${formatPEFValue(comp.subtotal)} ${cat.unit}</span>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                            
                            ${cat.contribution_tree.Packaging.total > 0 ? `
                            <div class="audit-component">
                                <div class="audit-component-header">
                                    <span>Packaging</span>
                                    <span>${formatPEFValue(cat.contribution_tree.Packaging.total)} ${cat.unit}</span>
                                </div>
                                ${cat.contribution_tree.Packaging.components.map(comp => `
                                    <div class="audit-item">
                                        <span class="audit-item-name">${comp.name}</span>
                                        <span class="audit-item-value">${formatPEFValue(comp.subtotal)} ${cat.unit}</span>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
            });

            auditContent.innerHTML = auditHTML;
        }

        // ================== DIGITAL TRANSPARENCY CARD ==================
        function generateDPP() {
            const productName = document.getElementById('productName').value || 'Unnamed Product';
            const dppId = currentDPPId || 'TRC-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            currentDPPId = dppId;
            
            document.getElementById('dppId').textContent = dppId;
            
            // Build transparency card data
            const transparencyData = {
                productId: dppId,
                productName: productName,
                timestamp: new Date().toISOString(),
                methodology: {
                    approach: "PEF 3.1",
                    version: "1.0",
                    dataSources: ["AGRIBALYSE 3.2", "JRC EF 3.1", "AWARE 2.0"],
                    standards: ["Science-Based Reporting", "Transparent Methodology"]
                },
                environmentalFootprint: finalPefResults,
                data_quality: auditTrailData.dqr_summary,
                mass_balance: massBalanceData,
                comparison_baseline: currentComparisonBaseline
            };
            
            const qrElement = document.getElementById('qrcode');
            qrElement.innerHTML = '';
            
            QRCode.toCanvas(qrElement, JSON.stringify(transparencyData, null, 2), {
                width: 200,
                height: 200,
                margin: 1,
                color: {
                    dark: '#0A2540',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) console.error(error);
            });
        }

        // ================== EXPORT FUNCTIONALITY ==================
        function generatePDFReport(reportType) {
            const loadingOverlay = document.getElementById('pdf-loading-overlay');
            if (loadingOverlay) loadingOverlay.style.display = 'flex';

            setTimeout(() => {
                alert(`Generating ${reportType} PDF report...\n\nIn a full implementation, this would generate a professional PDF with:\n- Complete PEF scorecard\n- Transparency log\n- Methodology statements\n- Business case analysis\n- Digital Transparency Card documentation`);
                
                if (loadingOverlay) loadingOverlay.style.display = 'none';
            }, 1500);
        }

        function downloadRawData() {
            if (!auditTrailData) {
                alert('No data available to download. Please run a calculation first.');
                return;
            }
            
            const dataStr = JSON.stringify(auditTrailData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `aioxy-transparency-data-${currentDPPId || 'export'}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function downloadDPPData() {
            if (!currentDPPId) {
                alert('No transparency card available. Please generate a Digital Transparency Card first.');
                return;
            }
            
            const productName = document.getElementById('productName').value || 'Unnamed Product';
            const transparencyData = {
                productId: currentDPPId,
                productName: productName,
                timestamp: new Date().toISOString(),
                environmentalFootprint: finalPefResults,
                data_quality: auditTrailData.dqr_summary,
                mass_balance: massBalanceData
            };
            
            const dataStr = JSON.stringify(transparencyData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `aioxy-transparency-card-${currentDPPId}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function downloadAllData() {
            if (!auditTrailData) {
                alert('No data available to download. Please run a calculation first.');
                return;
            }
            
            const dataStr = JSON.stringify({
                transparency_log: auditTrailData,
                pef_results: finalPefResults,
                mass_balance: massBalanceData,
                ingredients: selectedIngredients,
                metadata: {
                    platform: "AIOXY Science-Based Sustainability",
                    version: "2.1",
                    export_timestamp: new Date().toISOString()
                }
            }, null, 2);
            
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `aioxy-complete-dataset-${currentDPPId || 'export'}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportAuditData() {
            downloadRawData();
        }

        function downloadMethodology() {
            alert("Downloading complete methodology documentation...\n\nThis would include:\n- PEF 3.1 methodology guide\n- AGRIBALYSE 3.2 data sources\n- CFF calculation methodology\n- Uncertainty analysis approach\n- Science-based reporting approach");
        }

        // ================== UTILITY FUNCTIONS ==================
        function formatPEFValue(value) {
            if (value === 0) return "0.00";
            if (value < 0.0001) return value.toExponential(3);
            if (value < 1) return value.toFixed(5);
            if (value < 1000) return value.toFixed(2);
            return value.toFixed(1);
        }

        function createEmissionChart(results) {
            const ctx = document.getElementById('emissionChart').getContext('2d');
            
            if (currentChart) currentChart.destroy();
            
            // Get contribution data from audit trail
            const ingredientsCO2 = auditTrailData.pefCategories?.["Climate Change"]?.contribution_tree?.Ingredients?.total || 0;
            const processingCO2 = auditTrailData.pefCategories?.["Climate Change"]?.contribution_tree?.Manufacturing?.total || 0;
            const transportCO2 = auditTrailData.pefCategories?.["Climate Change"]?.contribution_tree?.Transport?.total || 0;
            const packagingCO2 = auditTrailData.pefCategories?.["Climate Change"]?.contribution_tree?.Packaging?.total || 0;
            
            currentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ingredients', 'Processing', 'Transportation', 'Packaging'],
                    datasets: [{
                        data: [
                            Math.max(ingredientsCO2, 0),
                            Math.max(processingCO2, 0),
                            Math.max(transportCO2, 0),
                            Math.max(packagingCO2, 0)
                        ],
                        backgroundColor: ['#2E86C1', '#27AE60', '#F39C12', '#E74C3C'],
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 37, 64, 0.9)',
                            titleFont: {
                                size: 13
                            },
                            bodyFont: {
                                size: 12
                            },
                            padding: 10,
                            cornerRadius: 6,
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw.toFixed(2)} kg CO₂e`;
                                }
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
        }

        // ================== INITIALIZE APPLICATION ==================
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
